<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Boardroom</title>
    <style>
        /* --- Base & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #f3f4f6; min-height: 100vh; color: #1f2937; }
        h1, h2, h3 { color: #111827; }
        .hidden { display: none !important; }
        
        /* --- Buttons --- */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; } .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; } .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; } .btn-danger:hover { background: #dc2626; }
        .btn-small { padding: 8px 16px; width: auto; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 24px; }
        .btn-group button { width: auto; padding: 8px 16px; }

        /* --- Forms & Inputs --- */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; margin-bottom: 16px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
        .error-message { color: #ef4444; font-size: 14px; margin-bottom: 12px; text-align: center; min-height: 1em; }
        
        /* --- Authentication Screen --- */
        .auth-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
            background: url('static/image/login-bg.jpg') center/cover no-repeat;
            position: relative;
        }
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }
        .auth-box { 
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
            padding: 40px; 
            max-width: 420px; 
            width: 100%; 
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }
        .form-toggle { text-align: center; margin-top: 24px; font-size: 14px; }
        .form-toggle a { color: #2563eb; text-decoration: none; font-weight: 600; cursor: pointer; }

        /* --- Main App Layout --- */
        .app-container { 
            background: url('static/image/dashboard-bg.jpg') center/cover no-repeat fixed;
            min-height: 100vh; 
            position: relative;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }
        .header { background: rgba(255, 255, 255, 0.98); box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-nav { display: flex; gap: 8px; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 32px 16px; position: relative; z-index: 1; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
        .grid-2col { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        
        /* --- Dashboard --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 16px; color: #6b7280; margin-bottom: 8px; }
        .stat-card .value { font-size: 36px; font-weight: 700; }
        .dashboard-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; }
        .dept-item { margin-bottom: 16px; }
        .dept-item-header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; }
        .progress-bar { background: #e5e7eb; border-radius: 99px; height: 10px; overflow: hidden; }
        .progress-bar-inner { background: #2563eb; height: 100%; border-radius: 99px; transition: width 0.5s ease; }
        .user-list { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .user-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info .details { font-size: 14px; }
        .user-info .details .email { font-size: 12px; color: #6b7280; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #9ca3af; }
        .status-indicator.active { background: #10b981; }

        /* --- Teams --- */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .team-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; transition: box-shadow 0.2s; }
        .team-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .flex-row { display: flex; gap: 8px; }
        .flex-1 { flex: 1; }

        /* --- Team Detail View --- */
        .project-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .member-list { display: flex; flex-direction: column; gap: 8px; }
        .member-item { display: flex; align-items: center; gap: 8px; }
        .member-avatar { width: 32px; height: 32px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
        .chat-container { height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #f9fafb; }
        .chat-message { margin-bottom: 12px; }
        .chat-user { font-weight: 600; color: #2563eb; margin-right: 8px; }
        .chat-user.system { color: #6b7280; }
        .chat-time { font-size: 11px; color: #9ca3af; }
        .chat-text { margin-top: 4px; color: #374151; }
        .task-completed { text-decoration: line-through; color: #9ca3af; }
        
        /* --- Task Management Enhancements --- */
        .task-filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .filter-btn:hover { border-color: #2563eb; }
        .task-item { display: flex; align-items: flex-start; gap: 8px; padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: move; transition: all 0.2s; }
        .task-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .task-item.dragging { opacity: 0.5; }
        .task-checkbox { margin-top: 2px; }
        .task-content { flex: 1; }
        .task-header { display: flex; justify-content: space-between; align-items: start; gap: 8px; margin-bottom: 4px; }
        .task-text { flex: 1; word-break: break-word; }
        .task-status { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .task-status.todo { background: #dbeafe; color: #1e40af; }
        .task-status.inprogress { background: #fef3c7; color: #92400e; }
        .task-status.done { background: #d1fae5; color: #065f46; }
        .task-status.blocked { background: #fee2e2; color: #991b1b; }
        .task-meta { display: flex; gap: 8px; font-size: 12px; color: #6b7280; margin-top: 4px; align-items: center; }
        .task-due { display: flex; align-items: center; gap: 4px; }
        .task-due.overdue { color: #ef4444; font-weight: 600; }
        .task-actions { display: flex; gap: 4px; }
        .task-action-btn { background: #f3f4f6; border: none; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .task-action-btn:hover { background: #e5e7eb; }
        
        /* --- Documents --- */
        .document-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        .document-actions { display: flex; gap: 8px; }
        .icon-btn { background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:hover { background: #e5e7eb; }
        
        /* --- Modals --- */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1001; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; width: auto; padding: 0; }
        .meeting-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        /* --- Call Modal --- */
        .video-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; padding: 1rem; }
        .video-wrapper { position: relative; background: #2c2f33; border-radius: 8px; overflow: hidden; width: 300px; height: 225px; display: flex; align-items: center; justify-content: center; }
        .video-wrapper video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .video-wrapper p { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: 500; }
        .audio-avatar { display: none; color: white; text-align: center; }
        .audio-avatar svg { width: 60px; height: 60px; opacity: 0.7; }
        .video-wrapper.is-audio-only video { display: none; }
        .video-wrapper.is-audio-only .audio-avatar { display: block; }
        .video-wrapper.is-screen-share { width: 100%; max-width: 800px; height: 450px; }
        
        /* --- File Preview Modal --- */
        .preview-modal .modal-content { max-width: 95%; max-height: 95vh; }
        .preview-container { width: 100%; height: 70vh; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px; overflow: hidden; }
        .preview-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .preview-container iframe { width: 100%; height: 100%; border: none; }
        .preview-unsupported { text-align: center; color: #6b7280; padding: 40px; }
        
        /* --- Call Controls --- */
        .call-controls { display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .control-btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .control-btn.share { background: #8b5cf6; color: white; }
        .control-btn.share:hover { background: #7c3aed; }
        .control-btn.share.active { background: #059669; }
        
        /* --- Kanban Board --- */
        .view-toggle { display: flex; gap: 8px; margin-bottom: 24px; }
        .view-btn { padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .view-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .kanban-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
        .kanban-column { background: #f3f4f6; border-radius: 8px; padding: 16px; min-width: 300px; max-width: 300px; }
        .kanban-column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .kanban-column-title { font-weight: 700; font-size: 16px; }
        .kanban-column-count { background: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .kanban-cards { min-height: 100px; }
        .kanban-card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: move; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; }
        .kanban-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .kanban-card.dragging { opacity: 0.5; transform: rotate(5deg); }
        .kanban-card-title { font-weight: 600; margin-bottom: 8px; }
        .kanban-card-meta { display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 8px; }
        .kanban-card-priority { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .priority-high { background: #fee2e2; color: #991b1b; }
        .priority-medium { background: #fef3c7; color: #92400e; }
        .priority-low { background: #dbeafe; color: #1e40af; }
        .kanban-add-card { width: 100%; padding: 8px; border: 2px dashed #d1d5db; border-radius: 8px; background: transparent; color: #6b7280; cursor: pointer; font-size: 14px; }
        .kanban-add-card:hover { border-color: #2563eb; color: #2563eb; background: rgba(37, 99, 235, 0.05); }
        .timeline-view { padding: 24px; }
        .timeline-item { display: flex; gap: 16px; margin-bottom: 24px; }
        .timeline-date { min-width: 120px; font-weight: 600; color: #2563eb; }
        .timeline-content { flex: 1; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* --- Whiteboard --- */
        .whiteboard-container { position: relative; width: 100%; height: calc(100vh - 200px); background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .whiteboard-toolbar { display: flex; gap: 8px; padding: 16px; background: white; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap; }
        .tool-btn { padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .tool-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .tool-btn:hover { border-color: #2563eb; }
        .color-picker { width: 40px; height: 40px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; }
        .size-slider { width: 120px; }
        #whiteboardCanvas { cursor: crosshair; display: block; }
        .cursor-indicator { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #2563eb; pointer-events: none; transform: translate(-50%, -50%); transition: all 0.1s; }
        .cursor-label { position: absolute; background: #2563eb; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; pointer-events: none; transform: translate(-50%, -150%); white-space: nowrap; }
        
        /* --- Analytics Dashboard --- */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-card h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
        .metric-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .metric-label { color: #6b7280; font-size: 14px; }
        .metric-value { font-weight: 600; font-size: 16px; color: #111827; }
        .activity-heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 4px; background: #e5e7eb; transition: all 0.2s; }
        .heatmap-cell.level-1 { background: #dbeafe; }
        .heatmap-cell.level-2 { background: #93c5fd; }
        .heatmap-cell.level-3 { background: #3b82f6; }
        .heatmap-cell.level-4 { background: #1e40af; }
        .progress-ring { width: 120px; height: 120px; margin: 0 auto; }
        
        /* --- Time Tracking --- */
        .timer-display { font-size: 48px; font-weight: 700; text-align: center; margin: 24px 0; color: #2563eb; font-family: 'Courier New', monospace; }
        .timer-controls { display: flex; gap: 12px; justify-content: center; margin-bottom: 32px; }
        .time-entries { max-height: 400px; overflow-y: auto; }
        .time-entry { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        .time-entry-info h4 { font-weight: 600; margin-bottom: 4px; }
        .time-entry-info p { font-size: 13px; color: #6b7280; }
        .time-duration { font-weight: 700; font-size: 18px; color: #2563eb; }
        
        /* --- Recording Controls --- */
        .recording-indicator { display: none; background: #ef4444; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; animation: pulse 2s infinite; }
        .recording-indicator.active { display: inline-flex; align-items: center; gap: 8px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .recording-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* --- Document Editor --- */
        .editor-container { display: flex; gap: 24px; height: calc(100vh - 250px); }
        .editor-main { flex: 1; background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .editor-toolbar { display: flex; gap: 8px; padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .editor-content { min-height: 400px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; outline: none; background: white; }
        .editor-content:focus { border-color: #2563eb; }
        .editor-sidebar { width: 300px; background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-y: auto; }
        .comment-item { padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #2563eb; }
        .comment-author { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .comment-text { font-size: 13px; color: #374151; margin-bottom: 6px; }
        .comment-time { font-size: 11px; color: #9ca3af; }
        .comment-input { display: flex; gap: 8px; margin-top: 16px; }
        .active-users { display: flex; gap: 8px; padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 16px; }
        .user-badge { padding: 4px 12px; background: white; border-radius: 16px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .user-badge-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }
        
        /* --- Theme Customizer --- */
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 24px; }
        .theme-card { padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; }
        .theme-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .theme-card.active { border-color: #2563eb; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2); }
        .theme-preview { height: 60px; border-radius: 8px; margin-bottom: 12px; display: flex; }
        .theme-preview-section { flex: 1; }
        .theme-name { font-weight: 600; text-align: center; }
        .custom-color-picker { display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap; }
        .color-option { text-align: center; }
        .color-option label { display: block; font-size: 13px; color: #6b7280; margin-bottom: 6px; }
        .color-option input[type="color"] { width: 80px; height: 80px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; }
        
        /* --- Calendar --- */
        .calendar-container { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
        .calendar-day:hover { background: #f3f4f6; }
        .calendar-day.today { background: #dbeafe; border-color: #2563eb; }
        .calendar-day.has-event { background: #fef3c7; }
        .calendar-day.selected { background: #2563eb; color: white; }
        .calendar-day-number { font-weight: 600; font-size: 14px; }
        .calendar-event-dot { width: 6px; height: 6px; background: #2563eb; border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
        .calendar-events-list { margin-top: 24px; }
        .calendar-event-item { padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        .event-time { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .event-title { font-weight: 600; margin-bottom: 4px; }
        .event-attendees { font-size: 13px; color: #6b7280; }
        .conflict-warning { background: #fee2e2; color: #991b1b; padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-top: 8px; }
        
        /* --- Profile Image --- */
        .profile-image-upload { text-align: center; margin-bottom: 20px; }
        .profile-image-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #2563eb; margin: 0 auto 16px; display: block; }
        .profile-image-placeholder { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: 700; }
        .upload-label { display: inline-block; padding: 10px 20px; background: #2563eb; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .upload-label:hover { background: #1d4ed8; transform: translateY(-2px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #2563eb; }
        .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 2px solid #2563eb; }
        
        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .animate-scale-in { animation: scaleIn 0.4s ease-out; }
        .animate-bounce { animation: bounce 2s infinite; }
        
        .stat-card { animation: fadeIn 0.6s ease-out; animation-fill-mode: both; }
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .stat-card .value { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .team-card { animation: scaleIn 0.4s ease-out; animation-fill-mode: both; }
        .kanban-card { animation: fadeIn 0.3s ease-out; }
        .task-item { animation: slideIn 0.3s ease-out; }
        .user-item { animation: fadeIn 0.3s ease-out; animation-fill-mode: both; }
        
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top: 4px solid #2563eb; border-radius: 50%; animation: rotate 1s linear infinite; margin: 40px auto; }
        
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .btn-primary, .btn-success, .btn-danger { position: relative; overflow: hidden; }
        .btn-primary::after, .btn-success::after, .btn-danger::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn-primary:active::after, .btn-success:active::after, .btn-danger:active::after { width: 300px; height: 300px; }
        
        .progress-bar-inner { transition: width 0.8s ease; }
        
        .modal.active { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: scaleIn 0.3s ease-out; }
        
        /* --- Keyboard Shortcuts --- */
        .shortcuts-help { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .shortcuts-btn { width: 50px; height: 50px; border-radius: 50%; background: #2563eb; color: white; border: none; cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); transition: all 0.3s; }
        .shortcuts-btn:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5); }
        .shortcuts-modal .modal-content { max-width: 600px; }
        .shortcut-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .shortcut-key { background: #f3f4f6; padding: 4px 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 600; font-size: 13px; }
        .shortcut-desc { color: #6b7280; }
        
        /* --- Polling System --- */
        .poll-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #2563eb; }
        .poll-question { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #111827; }
        .poll-option { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .poll-option:hover { border-color: #2563eb; background: #f0f9ff; }
        .poll-option.selected { border-color: #2563eb; background: #dbeafe; }
        .poll-option.voted { cursor: default; }
        .poll-option-text { position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .poll-progress { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #dbeafe 0%, #93c5fd 100%); transition: width 0.6s ease; z-index: 1; }
        .poll-votes { font-size: 13px; color: #6b7280; font-weight: 600; }
        .poll-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 13px; color: #6b7280; }
        .poll-status { display: flex; align-items: center; gap: 8px; }
        .poll-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .poll-badge.active { background: #d1fae5; color: #065f46; }
        .poll-badge.closed { background: #fee2e2; color: #991b1b; }
        .poll-badge.anonymous { background: #e0e7ff; color: #3730a3; }
        .create-poll-form { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .poll-options-input { display: flex; gap: 8px; margin-bottom: 8px; }
        .poll-options-list { margin-bottom: 16px; }
        .poll-option-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        /* Attendance Device Styles */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 24px 0;
}

.action-btn {
    padding: 20px;
    border: none;
    border-radius: 12px;
    background: white;
    border: 2px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.action-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.checkin-btn {
    border-color: #10b981;
    background: #f0fdf4;
}

.checkin-btn:hover:not(:disabled) {
    background: #10b981;
    color: white;
}

.checkout-btn {
    border-color: #ef4444;
    background: #fef2f2;
}

.checkout-btn:hover:not(:disabled) {
    background: #ef4444;
    color: white;
}

.break-btn {
    border-color: #f59e0b;
    background: #fefce8;
}

.break-btn:hover:not(:disabled) {
    background: #f59e0b;
    color: white;
}

.history-btn {
    border-color: #3b82f6;
    background: #eff6ff;
}

.history-btn:hover:not(:disabled) {
    background: #3b82f6;
    color: white;
}

.btn-icon {
    font-size: 24px;
}

.btn-text {
    font-weight: 600;
    font-size: 16px;
}

.btn-subtext {
    font-size: 12px;
    color: #6b7280;
}

/* Status Styles */
.status-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    border: 1px solid #e5e7eb;
    margin-bottom: 24px;
}

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.live-clock {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #2563eb;
    background: #f3f4f6;
    padding: 8px 16px;
    border-radius: 8px;
}

.status-content {
    display: flex;
    align-items: center;
    gap: 24px;
}

.status-indicator {
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 200px;
}

.status-indicator.checked-in {
    background: #d1fae5;
    color: #065f46;
    border-left: 4px solid #10b981;
}

.status-indicator.checked-out {
    background: #fef2f2;
    color: #991b1b;
    border-left: 4px solid #ef4444;
}

.status-indicator.on-break {
    background: #fef3c7;
    color: #92400e;
    border-left: 4px solid #f59e0b;
}

.status-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    gap: 16px;
}

.detail-label {
    color: #6b7280;
    font-weight: 500;
}

.detail-value {
    font-weight: 600;
    color: #111827;
}

/* Form Styles */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #374151;
}

/* Break Controls */
.break-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.break-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
}

.break-type-btn {
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.break-type-btn:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    transform: translateY(-2px);
}

.active-break-section {
    background: #f0f9ff;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

/* Summary Styles */
.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.date-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
}

.attendance-table th,
.attendance-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.attendance-table th {
    background: #f3f4f6;
    font-weight: 600;
    color: #374151;
}

.employee-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.stat-item {
    background: #f8fafc;
    padding: 16px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-weight: 700;
    font-size: 18px;
    color: #111827;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
}

.chart-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.large-btn {
    padding: 16px 24px;
    font-size: 16px;
    font-weight: 600;
}
    </style>
</head>
<body>

    <!-- Login/Register Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <!-- Login Form -->
            <div id="loginForm">
                <h1 style="text-align: center; margin-bottom: 24px;">Welcome Back</h1>
                <p class="error-message" id="loginError"></p>
                <input type="text" id="loginUsername" placeholder="Username" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button class="btn-primary" onclick="handleLogin()">Login</button>
                <div class="form-toggle">Don't have an account? <a onclick="toggleAuthForms()">Register here</a></div>
            </div>
            <!-- Registration Form -->
            <div id="registerForm" class="hidden">
                <h1 style="text-align: center; margin-bottom: 24px;">Create Account</h1>
                <p class="error-message" id="registerError"></p>
                
                <div class="profile-image-upload">
                    <div id="profileImagePreview" class="profile-image-placeholder">
                        <span id="profileInitial">üì∑</span>
                    </div>
                    <label for="profileImageInput" class="upload-label">
                        Upload Photo
                        <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImage(event)">
                    </label>
                </div>
                
                <input type="text" id="registerUsername" placeholder="Username" required>
                <input type="email" id="registerEmail" placeholder="Email Address" required>
                <input type="password" id="registerPassword" placeholder="Password" required>
                <select id="registerDepartment"></select>
                <button class="btn-primary" onclick="handleRegister()">Register</button>
                <div class="form-toggle">Already have an account? <a onclick="toggleAuthForms()">Login here</a></div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appScreen" class="app-container hidden">
        <div class="header">
            <div class="header-content">
                <h2 style="font-weight: 700;">Virtual Boardroom</h2>
                <div class="header-nav">
                    <button class="btn-primary btn-small" onclick="showDashboard()">Dashboard</button>
                    <button class="btn-primary btn-small" onclick="showTeams()">Teams</button>
                    <button class="btn-primary btn-small" onclick="showKanban()">üìä Kanban</button>
                    <button class="btn-primary btn-small" onclick="showWhiteboard()">üé® Whiteboard</button>
                    <button class="btn-primary btn-small" onclick="showAnalytics()">üìà Analytics</button>
                    <button class="btn-primary btn-small" onclick="showTimeTracking()">‚è±Ô∏è Time</button>
                    <button class="btn-primary btn-small" onclick="showEditor()">üìù Editor</button>
                    <button class="btn-primary btn-small" onclick="showCalendar()">üìÖ Calendar</button>
                    <button class="btn-primary btn-small" onclick="showThemes()">üé® Themes</button>
                    <button class="btn-primary btn-small" onclick="showPolls()">üìä Polls</button>
                    <!-- In your header navigation, add these two buttons -->
                    <button class="btn-primary btn-small" onclick="showAttendanceDevice()">‚è∞ Attendance</button>
                     <button class="btn-primary btn-small" onclick="showAttendanceSummary()">üìä Attendance Summary</button>
                    <span style="border-left: 1px solid #e5e7eb; margin: 0 8px;"></span>
                    <img id="userAvatar" class="user-avatar-small" style="display: none;">
                    <span id="usernameDisplay" style="align-self: center;"></span>
                    <button class="btn-danger btn-small" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Dashboard View -->
            <div id="dashboardView" class="hidden">
                <div class="dashboard-grid">
                    <div class="stat-card"><h3>Total Users</h3><p class="value" id="totalUsersStat">0</p></div>
                    <div class="stat-card"><h3>Active Now</h3><p class="value" id="activeNowStat">0</p></div>
                    <div class="stat-card"><h3>Total Teams</h3><p class="value" id="totalTeamsStat">0</p></div>
                    <div class="stat-card"><h3>Total Projects</h3><p class="value" id="totalProjectsStat">0</p></div>
                </div>
                <div class="dashboard-layout">
                    <div class="card"><h2 class="section-title">Department Overview</h2><div id="departmentOverview"></div></div>
                    <div class="card"><h2 class="section-title">Active Users</h2><div class="user-list" id="activeUsersList"></div></div>
                </div>
                <div class="card" style="margin-top: 24px;"><h2 class="section-title">All Registered Users</h2><div class="user-list" id="allUsersList"></div></div>
            </div>

            <!-- Teams List View -->
            <div id="teamsView" class="hidden">
                <div class="card">
                    <h2 class="section-title">Create New Team</h2>
                    <div class="flex-row">
                        <input type="text" id="newTeamInput" class="flex-1" placeholder="Team name">
                        <button class="btn-primary" style="width: auto; padding: 12px 24px;" onclick="createTeam()">Create</button>
                    </div>
                </div>
                <h2 class="section-title">Available Teams</h2>
                <div id="teamsList" class="team-grid"></div>
            </div>

            <!-- Team Detail View -->
            <div id="teamView" class="hidden">
                <button class="btn-primary btn-small" style="margin-bottom: 24px;" onclick="showTeams()">‚Üê Back to Teams</button>
                <div class="btn-group">
                    <button class="btn-primary btn-small" onclick="showDocumentsModal()">üìÑ Documents</button>
                    <button class="btn-primary btn-small" onclick="showScheduleModal()">üìÖ Schedule</button>
                    <button class="btn-success btn-small" onclick="startCall('video')">üìπ Video Call</button>
                    <button class="btn-primary btn-small" onclick="startCall('audio')">üìû Audio Call</button>
                </div>
                <div id="meetingsSection"></div>
                <div class="grid-2col">
                    <div>
                        <div class="card">
                            <h2 class="section-title">üìÅ Projects</h2>
                            <div class="flex-row">
                                <input type="text" id="newProjectInput" class="flex-1" placeholder="New project name">
                                <button class="btn-primary" style="width: auto; padding: 12px 24px;" onclick="createProject()">Add</button>
                            </div>
                            <div id="projectsList"></div>
                        </div>
                    </div>
                    <div>
                        <div class="card"><h2 class="section-title">üë• Team Members</h2><div id="membersList" class="member-list"></div></div>
                        <div class="card"><h2 class="section-title">üí¨ Team Chat</h2><div id="chatMessages" class="chat-container"></div>
                            <div class="flex-row">
                                <input type="text" id="chatInput" class="flex-1" placeholder="Type message..."><button class="btn-primary" style="width: auto; padding: 12px 24px;" onclick="sendMessage()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kanban Board View -->
            <div id="kanbanView" class="hidden">
                <div class="card">
                    <h2 class="section-title">üìä Kanban Board</h2>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchKanbanView('board')">Board View</button>
                        <button class="view-btn" onclick="switchKanbanView('list')">List View</button>
                        <button class="view-btn" onclick="switchKanbanView('timeline')">Timeline View</button>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <button class="btn-success btn-small" onclick="showAddCardModal()">+ Add Card</button>
                    </div>
                </div>
                
                <!-- Board View -->
                <div id="boardView" class="kanban-board"></div>
                
                <!-- List View -->
                <div id="listView" class="hidden" style="margin-top: 24px;">
                    <div id="listViewContent"></div>
                </div>
                
                <!-- Timeline View -->
                <div id="timelineView" class="hidden timeline-view">
                    <div id="timelineContent"></div>
                </div>
            </div>
            
            <!-- Whiteboard View -->
            <div id="whiteboardView" class="hidden">
                <div class="card">
                    <h2 class="section-title">üé® Collaborative Whiteboard</h2>
                    <div class="whiteboard-toolbar">
                        <button class="tool-btn active" onclick="setTool('pen')" id="penTool">‚úèÔ∏è Pen</button>
                        <button class="tool-btn" onclick="setTool('eraser')" id="eraserTool">üßπ Eraser</button>
                        <button class="tool-btn" onclick="setTool('line')" id="lineTool">üìè Line</button>
                        <button class="tool-btn" onclick="setTool('rectangle')" id="rectangleTool">‚¨ú Rectangle</button>
                        <button class="tool-btn" onclick="setTool('circle')" id="circleTool">‚≠ï Circle</button>
                        <button class="tool-btn" onclick="setTool('text')" id="textTool">üìù Text</button>
                        <input type="color" id="colorPicker" class="color-picker" value="#2563eb" onchange="setColor(this.value)">
                        <input type="range" id="sizeSlider" class="size-slider" min="1" max="20" value="3" onchange="setSize(this.value)">
                        <button class="tool-btn" onclick="clearWhiteboard()">üóëÔ∏è Clear</button>
                        <button class="tool-btn" onclick="saveWhiteboard()">üíæ Save</button>
                        <button class="tool-btn" onclick="loadWhiteboard()">üìÇ Load</button>
                    </div>
                    <div class="whiteboard-container">
                        <canvas id="whiteboardCanvas"></canvas>
                        <div id="cursorsContainer"></div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics View -->
            <div id="analyticsView" class="hidden">
                <h2 class="section-title">üìà Analytics Dashboard</h2>
                
                <div class="analytics-grid">
                    <div class="chart-card">
                        <h3>Team Productivity</h3>
                        <canvas id="productivityChart" height="200"></canvas>
                    </div>
                    
                    <div class="chart-card">
                        <h3>Project Completion Rates</h3>
                        <div class="progress-ring">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#e5e7eb" stroke-width="10"/>
                                <circle id="completionCircle" cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="10" 
                                    stroke-dasharray="314" stroke-dashoffset="78.5" transform="rotate(-90 60 60)"/>
                            </svg>
                        </div>
                        <p style="text-align: center; font-size: 32px; font-weight: 700; color: #10b981; margin-top: 16px;" id="completionRate">75%</p>
                        <p style="text-align: center; color: #6b7280;">Completed</p>
                    </div>
                    
                    <div class="chart-card">
                        <h3>User Engagement</h3>
                        <div id="engagementMetrics"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Activity Heatmap (Last 28 Days)</h3>
                    <div class="activity-heatmap" id="activityHeatmap"></div>
                    <div style="display: flex; justify-content: center; gap: 16px; margin-top: 16px; font-size: 12px; color: #6b7280;">
                        <span>Less <div class="heatmap-cell" style="display: inline-block; width: 12px; height: 12px; vertical-align: middle;"></div></span>
                        <div class="heatmap-cell level-1" style="display: inline-block; width: 12px; height: 12px;"></div>
                        <div class="heatmap-cell level-2" style="display: inline-block; width: 12px; height: 12px;"></div>
                        <div class="heatmap-cell level-3" style="display: inline-block; width: 12px; height: 12px;"></div>
                        <div class="heatmap-cell level-4" style="display: inline-block; width: 12px; height: 12px;"></div>
                        <span>More</span>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">üìä Task Analytics</h3>
                    <canvas id="taskAnalyticsChart" height="100"></canvas>
                </div>
            </div>
            
            <!-- Time Tracking View -->
            <div id="timeTrackingView" class="hidden">
                <div class="card">
                    <h2 class="section-title">‚è±Ô∏è Time Tracking</h2>
                    
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    
                    <div class="timer-controls">
                        <button class="btn-success" id="startTimerBtn" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                        <button class="btn-danger" id="stopTimerBtn" onclick="stopTimer()" disabled>‚è∏Ô∏è Stop</button>
                        <button class="btn-primary" onclick="resetTimer()">üîÑ Reset</button>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label>Task/Project Name</label>
                        <input type="text" id="timeTrackTaskName" placeholder="What are you working on?">
                        <button class="btn-primary" onclick="showAISummary()">ü§ñ AI Summary</button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Time Entries</h3>
                    <div class="time-entries" id="timeEntriesList"></div>
                </div>
                
                <div class="card" style="margin-top: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">üìä Time Reports</h3>
                    <canvas id="timeReportChart" height="100"></canvas>
                    <button class="btn-primary btn-small" style="margin-top: 16px;" onclick="exportTimeReport()">üìÑ Export Report</button>
                </div>
            </div>
            
            <!-- Collaborative Editor View -->
            <div id="editorView" class="hidden">
                <div class="card">
                    <h2 class="section-title">üìù Collaborative Document Editor</h2>
                    <div class="active-users" id="editorActiveUsers"></div>
                </div>
                
                <div class="editor-container">
                    <div class="editor-main">
                        <div class="editor-toolbar">
                            <button class="tool-btn" onclick="formatText('bold')"><strong>B</strong></button>
                            <button class="tool-btn" onclick="formatText('italic')"><em>I</em></button>
                            <button class="tool-btn" onclick="formatText('underline')"><u>U</u></button>
                            <button class="tool-btn" onclick="formatText('insertUnorderedList')">‚Ä¢ List</button>
                            <button class="tool-btn" onclick="formatText('insertOrderedList')">1. List</button>
                            <select onchange="formatText('fontSize', this.value); this.value='';" style="width: auto; margin: 0; padding: 8px;">
                                <option value="">Font Size</option>
                                <option value="1">Small</option>
                                <option value="3">Normal</option>
                                <option value="5">Large</option>
                                <option value="7">Huge</option>
                            </select>
                            <button class="btn-success btn-small" onclick="saveDocument()">üíæ Save</button>
                            <button class="btn-primary btn-small" onclick="loadDocument()">üìÇ Load</button>
                        </div>
                        <div id="editorContent" class="editor-content" contenteditable="true"></div>
                    </div>
                    
                    <div class="editor-sidebar">
                        <h3 style="font-weight: 700; margin-bottom: 16px;">üí¨ Comments</h3>
                        <div id="documentComments"></div>
                        <div class="comment-input">
                            <input type="text" id="commentInput" placeholder="Add a comment..." style="flex: 1; margin: 0;">
                            <button class="btn-primary btn-small" onclick="addComment()">Post</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar View -->
            <div id="calendarView" class="hidden">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-primary btn-small" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <h2 id="calendarMonthYear"></h2>
                        <button class="btn-primary btn-small" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Sun</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Mon</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Tue</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Wed</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Thu</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Fri</div>
                        <div style="text-align: center; font-weight: 600; color: #6b7280;">Sat</div>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid"></div>
                    
                    <div class="calendar-events-list">
                        <h3 style="font-weight: 700; margin-bottom: 16px;">Scheduled Events</h3>
                        <div id="calendarEventsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Themes View -->
            <div id="themesView" class="hidden">
                <div class="card">
                    <h2 class="section-title">üé® Customize Your Theme</h2>
                    
                    <h3 style="font-weight: 700; margin-bottom: 16px;">Preset Themes</h3>
                    <div class="theme-grid" id="themeGrid"></div>
                    
                    <h3 style="font-weight: 700; margin: 32px 0 16px;">Custom Colors</h3>
                    <div class="custom-color-picker">
                        <div class="color-option">
                            <label>Primary Color</label>
                            <input type="color" id="primaryColor" value="#2563eb" onchange="applyCustomTheme()">
                        </div>
                        <div class="color-option">
                            <label>Success Color</label>
                            <input type="color" id="successColor" value="#10b981" onchange="applyCustomTheme()">
                        </div>
                        <div class="color-option">
                            <label>Danger Color</label>
                            <input type="color" id="dangerColor" value="#ef4444" onchange="applyCustomTheme()">
                        </div>
                        <div class="color-option">
                            <label>Background</label>
                            <input type="color" id="backgroundColor" value="#f3f4f6" onchange="applyCustomTheme()">
                        </div>
                    </div>
                    
                    <button class="btn-primary" style="margin-top: 24px;" onclick="resetTheme()">üîÑ Reset to Default</button>
                </div>
            </div>
            
            <!-- Polls View -->
            <div id="pollsView" class="hidden">
                <div class="create-poll-form">
                    <h2 class="section-title">üìä Create New Poll</h2>
                    <label>Poll Question</label>
                    <input type="text" id="pollQuestion" placeholder="What would you like to ask?">
                    
                    <label>Options</label>
                    <div class="poll-options-list" id="pollOptionsList">
                        <div class="poll-option-item">
                            <input type="text" class="poll-option-input" placeholder="Option 1" style="flex: 1; margin: 0;">
                            <button class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
                        </div>
                        <div class="poll-option-item">
                            <input type="text" class="poll-option-input" placeholder="Option 2" style="flex: 1; margin: 0;">
                            <button class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
                        </div>
                    </div>
                    <button class="btn-primary btn-small" onclick="addPollOption()">+ Add Option</button>
                    
                    <div style="margin: 16px 0;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="anonymousPoll">
                            <span>Anonymous voting</span>
                        </label>
                    </div>
                    
                    <button class="btn-success" onclick="createPoll()">Create Poll</button>
                </div>
                
                <h2 class="section-title">Active Polls</h2>
                <div id="pollsList"></div>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Button -->
    <div class="shortcuts-help">
        <button class="shortcuts-btn" onclick="showShortcutsModal()" title="Keyboard Shortcuts (?)">‚å®Ô∏è</button>
    </div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal shortcuts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                <button class="close-btn" onclick="closeShortcutsModal()">√ó</button>
            </div>
            
            <h3 style="font-weight: 700; margin: 20px 0 12px; color: #2563eb;">Navigation</h3>
            <div class="shortcut-item">
                <span class="shortcut-desc">Dashboard</span>
                <span class="shortcut-key">Alt + D</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Teams</span>
                <span class="shortcut-key">Alt + T</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Kanban Board</span>
                <span class="shortcut-key">Alt + K</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Whiteboard</span>
                <span class="shortcut-key">Alt + W</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Analytics</span>
                <span class="shortcut-key">Alt + A</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Calendar</span>
                <span class="shortcut-key">Alt + C</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Polls</span>
                <span class="shortcut-key">Alt + P</span>
            </div>
            
            <h3 style="font-weight: 700; margin: 20px 0 12px; color: #2563eb;">Actions</h3>
            <div class="shortcut-item">
                <span class="shortcut-desc">New Team</span>
                <span class="shortcut-key">Ctrl + N</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Search</span>
                <span class="shortcut-key">Ctrl + F</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Save Document</span>
                <span class="shortcut-key">Ctrl + S</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Show Shortcuts</span>
                <span class="shortcut-key">?</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-desc">Escape/Close Modal</span>
                <span class="shortcut-key">Esc</span>
            </div>
        </div>
    </div>

    <!-- Schedule Meeting Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Schedule Meeting</h2>
                <button class="close-btn" onclick="closeScheduleModal()">√ó</button>
            </div>
            <label>Meeting Title</label>
            <input type="text" id="meetingTitle" placeholder="Enter meeting title">
            <label>Date</label>
            <input type="date" id="meetingDate">
            <label>Time</label>
            <input type="time" id="meetingTime">
            <label>Meeting Type</label>
            <select id="meetingType">
                <option value="video">Video Call</option>
                <option value="audio">Audio Call</option>
            </select>
            <button class="btn-success" onclick="scheduleMeeting()">Schedule Meeting</button>
        </div>
    </div>

    <!-- Documents Modal -->
    <div id="documentsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Team Documents</h2>
                <button class="close-btn" onclick="closeDocumentsModal()">√ó</button>
            </div>
            <div style="margin-bottom: 24px;">
                <label class="btn-primary" style="cursor: pointer; text-align: center;">
                    üì§ Upload Document
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
                </label>
            </div>
            <div id="documentsList"></div>
        </div>
    </div>
    
    <!-- Call Modal -->
    <div id="callModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="callModalTitle">Video Call</h2>
                <button class="close-btn" onclick="endCall()">√ó</button>
            </div>
            <div id="videosContainer" class="video-container">
                <div id="localVideoWrapper" class="video-wrapper">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="audio-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                        </svg>
                    </div>
                    <p id="localVideoUsername">You</p>
                </div>
            </div>
            <div class="call-controls">
                <button id="shareScreenBtn" class="control-btn share" onclick="toggleScreenShare()">
                    üñ•Ô∏è <span id="shareScreenText">Share Screen</span>
                </button>
                <button id="recordBtn" class="control-btn share" onclick="toggleRecording()">
                    ‚è∫Ô∏è <span id="recordText">Record</span>
                </button>
                <span class="recording-indicator" id="recordingIndicator">
                    <span class="recording-dot"></span> Recording
                </span>
                <button class="btn-danger" onclick="endCall()">End Call</button>
            </div>
        </div>
    </div>
    
    <!-- File Preview Modal -->
    <div id="previewModal" class="modal preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="previewTitle">File Preview</h2>
                <button class="close-btn" onclick="closePreviewModal()">√ó</button>
            </div>
            <div id="previewContainer" class="preview-container"></div>
            <div style="margin-top: 16px; text-align: center;">
                <button class="btn-primary btn-small" onclick="downloadCurrentPreview()">‚¨áÔ∏è Download</button>
            </div>
        </div>
    </div>
    
    <!-- Task Edit Modal -->
    <div id="taskEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Task</h2>
                <button class="close-btn" onclick="closeTaskEditModal()">√ó</button>
            </div>
            <label>Task Description</label>
            <input type="text" id="editTaskText" placeholder="Task description">
            <label>Status</label>
            <select id="editTaskStatus">
                <option value="todo">To Do</option>
                <option value="inprogress">In Progress</option>
                <option value="done">Done</option>
                <option value="blocked">Blocked</option>
            </select>
            <label>Due Date</label>
            <input type="date" id="editTaskDueDate">
            <label>Assigned To</label>
            <select id="editTaskAssignee"></select>
            <button class="btn-success" onclick="saveTaskEdit()">Save Changes</button>
        </div>
    </div>
    
    <!-- Add Kanban Card Modal -->
    <div id="addCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Card</h2>
                <button class="close-btn" onclick="closeAddCardModal()">√ó</button>
            </div>
            <label>Title</label>
            <input type="text" id="cardTitle" placeholder="Card title">
            <label>Description</label>
            <textarea id="cardDescription" placeholder="Card description" rows="3"></textarea>
            <label>Priority</label>
            <select id="cardPriority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
            <label>Due Date</label>
            <input type="date" id="cardDueDate">
            <label>Status</label>
            <select id="cardStatus">
                <option value="todo">To Do</option>
                <option value="inprogress">In Progress</option>
                <option value="review">Review</option>
                <option value="done">Done</option>
            </select>
            <button class="btn-success" onclick="addKanbanCard()">Add Card</button>
        </div>
    </div>
<!-- ATTENDANCE DEVICE VIEW -->
<div id="attendanceDeviceView" class="hidden">
    <div class="card">
        <h2 class="section-title">‚è∞ Attendance Device</h2>
        <p style="color: #6b7280; margin-bottom: 24px;">Check in when you arrive and check out when you leave</p>
        
        <!-- Current Status -->
        <div class="status-card">
            <div class="status-header">
                <h3>Current Status</h3>
                <div class="live-clock" id="liveClock"></div>
            </div>
            <div class="status-content">
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-icon">üî¥</span>
                    <span class="status-text" id="statusText">Not Checked In</span>
                </div>
                <div class="status-details" id="statusDetails">
                    <div class="detail-item">
                        <span class="detail-label">Check-in Time:</span>
                        <span class="detail-value" id="checkinTimeDisplay">--:--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Session Duration:</span>
                        <span class="detail-value" id="sessionDurationDisplay">0h 0m</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Breaks Today:</span>
                        <span class="detail-value" id="breaksCountDisplay">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-grid">
            <button class="action-btn checkin-btn" onclick="quickCheckIn()" id="quickCheckinBtn">
                <span class="btn-icon">‚úÖ</span>
                <span class="btn-text">Check In</span>
                <span class="btn-subtext">Start your workday</span>
            </button>
            
            <button class="action-btn checkout-btn" onclick="quickCheckOut()" id="quickCheckoutBtn" disabled>
                <span class="btn-icon">üö™</span>
                <span class="btn-text">Check Out</span>
                <span class="btn-subtext">End your workday</span>
            </button>
            
            <button class="action-btn break-btn" onclick="toggleBreak()" id="breakBtn" disabled>
                <span class="btn-icon" id="breakIcon">‚òï</span>
                <span class="btn-text" id="breakText">Take Break</span>
                <span class="btn-subtext" id="breakSubtext">15 min break</span>
            </button>
            
            <button class="action-btn history-btn" onclick="showTodayLog()">
                <span class="btn-icon">üìù</span>
                <span class="btn-text">Today's Log</span>
                <span class="btn-subtext">View your activity</span>
            </button>
        </div>

        <!-- Detailed Check-in Form -->
        <div class="card" style="margin-top: 24px;">
            <h3 style="font-weight: 700; margin-bottom: 16px;">Detailed Check-in</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìç Work Location</label>
                    <select id="workLocation">
                        <option value="office_main">üè¢ Main Office</option>
                        <option value="office_branch">üè¨ Branch Office</option>
                        <option value="remote">üè† Remote Work</option>
                        <option value="client_site">üë• Client Site</option>
                        <option value="other">üîπ Other Location</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üíº Work Mode</label>
                    <select id="workMode">
                        <option value="full_time">Full Time (9AM-6PM)</option>
                        <option value="part_time">Part Time</option>
                        <option value="flexible">Flexible Hours</option>
                        <option value="overtime">Overtime</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>üìù Check-in Notes</label>
                <textarea id="checkinNotes" placeholder="What are you planning to work on today? Any important tasks or meetings?" rows="3"></textarea>
            </div>
            
            <button class="btn-success large-btn" onclick="detailedCheckIn()" style="width: 100%;">
                <span class="btn-icon">‚úÖ</span>
                <span class="btn-text">Check In with Details</span>
            </button>
        </div>

        <!-- Break Management -->
        <div class="card" style="margin-top: 24px;">
            <h3 style="font-weight: 700; margin-bottom: 16px;">‚òï Break Management</h3>
            
            <div class="break-controls">
                <div class="break-options">
                    <button class="break-type-btn" onclick="startQuickBreak('coffee')">
                        <span>‚òï</span>
                        <span>Coffee Break</span>
                        <small>15 min</small>
                    </button>
                    <button class="break-type-btn" onclick="startQuickBreak('lunch')">
                        <span>üçΩÔ∏è</span>
                        <span>Lunch Break</span>
                        <small>60 min</small>
                    </button>
                    <button class="break-type-btn" onclick="startQuickBreak('personal')">
                        <span>üö∂</span>
                        <span>Personal Break</span>
                        <small>10 min</small>
                    </button>
                </div>
                
                <div id="activeBreakSection" class="active-break-section" style="display: none;">
                    <div class="active-break-info">
                        <h4 id="activeBreakType">Active Break</h4>
                        <p id="activeBreakDuration">Duration: 0m 0s</p>
                    </div>
                    <button class="btn-primary" onclick="endCurrentBreak()">End Break</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ATTENDANCE SUMMARY VIEW -->
<div id="attendanceSummaryView" class="hidden">
    <div class="card">
        <h2 class="section-title">üìä Attendance Summary & Reports</h2>
        <p style="color: #6b7280; margin-bottom: 24px;">View attendance reports, analytics, and export data</p>
        
        <!-- Summary Cards -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Employees</h3>
                <p class="value" id="summaryTotalEmployees">0</p>
            </div>
            <div class="stat-card">
                <h3>Present Today</h3>
                <p class="value" id="summaryPresentToday">0</p>
            </div>
            <div class="stat-card">
                <h3>Absent Today</h3>
                <p class="value" id="summaryAbsentToday">0</p>
            </div>
            <div class="stat-card">
                <h3>Avg. Attendance</h3>
                <p class="value" id="summaryAvgAttendance">0%</p>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="card">
        <h3 style="font-weight: 700; margin-bottom: 16px;">Report Filters</h3>
        
        <div class="filter-controls">
            <div class="filter-group">
                <label>Date Range</label>
                <div class="date-range">
                    <input type="date" id="summaryStartDate">
                    <span>to</span>
                    <input type="date" id="summaryEndDate">
                </div>
            </div>
            
            <div class="filter-group">
                <label>Department</label>
                <select id="summaryDepartment">
                    <option value="all">All Departments</option>
                    <option value="HR">HR</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Sales">Sales</option>
                    <option value="Finance">Finance</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Report Type</label>
                <select id="reportType">
                    <option value="daily">Daily Summary</option>
                    <option value="weekly">Weekly Report</option>
                    <option value="monthly">Monthly Report</option>
                    <option value="custom">Custom Period</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons" style="margin-top: 16px;">
            <button class="btn-primary" onclick="generateAttendanceReport()">Generate Report</button>
            <button class="btn-success" onclick="downloadAttendanceCSV()">üìÑ Export CSV</button>
            <button class="btn-primary" onclick="downloadAttendancePDF()">üìä Export PDF</button>
            <button class="btn-primary" onclick="printAttendanceReport()">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <!-- Attendance Table -->
    <div class="card">
        <h3 style="font-weight: 700; margin-bottom: 16px;">Attendance Records</h3>
        
        <div class="table-container">
            <table id="attendanceSummaryTable" class="attendance-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                        <th>Hours</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="attendanceSummaryBody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="card">
        <h3 style="font-weight: 700; margin-bottom: 16px;">üìà Attendance Analytics</h3>
        
        <div class="analytics-grid">
            <div class="chart-card">
                <h4>Attendance Rate by Department</h4>
                <canvas id="departmentChart" height="200"></canvas>
            </div>
            
            <div class="chart-card">
                <h4>Daily Attendance Trend</h4>
                <canvas id="trendChart" height="200"></canvas>
            </div>
            
            <div class="chart-card">
                <h4>Punctuality Analysis</h4>
                <canvas id="punctualityChart" height="200"></canvas>
            </div>
            
            <div class="chart-card">
                <h4>Break Patterns</h4>
                <canvas id="breakChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Employee Statistics -->
    <div class="card">
        <h3 style="font-weight: 700; margin-bottom: 16px;">üë• Employee Statistics</h3>
        
        <div class="employee-stats">
            <div class="stat-item">
                <span class="stat-label">Most Punctual</span>
                <span class="stat-value" id="mostPunctual">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Most Absences</span>
                <span class="stat-value" id="mostAbsences">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Avg. Work Hours</span>
                <span class="stat-value" id="avgWorkHours">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Overtime</span>
                <span class="stat-value" id="totalOvertime">-</span>
            </div>
        </div>
    </div>
</div>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    
    <script>
// --- GLOBAL STATE & CONSTANTS ---
const departments = ["Engineering", "Marketing", "Sales", "HR", "Finance", "Operations", "Customer Support", "Product Management", "Design", "Legal"];
let socket;
let currentUser = null;
let teams = [];
let selectedTeam = null;
let localStream;
let peers = {};
let callType = 'video';
let screenStream = null;
let isScreenSharing = false;
let currentTaskFilter = 'all';
let editingTask = null;
let currentPreviewDoc = null;
let kanbanCards = [];
let currentKanbanView = 'board';
let whiteboardTool = 'pen';
let whiteboardColor = '#2563eb';
let whiteboardSize = 3;
let isDrawing = false;
let whiteboardData = [];
let remoteCursors = {};
let timerInterval = null;
let timerSeconds = 0;
let isTimerRunning = false;
let timeEntries = [];
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let documentComments = [];
let editorContent = '';
let currentTheme = 'default';
let calendarDate = new Date();
let calendarEvents = [];
let profileImageData = null;
let polls = [];

document.addEventListener('DOMContentLoaded', () => {
    const deptSelect = document.getElementById('registerDepartment');
    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptSelect.appendChild(option);
    });

    document.getElementById('loginUsername').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('registerPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    
    // Keyboard shortcuts
    setupKeyboardShortcuts();
    
    // Load saved theme
    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme && themes[savedTheme]) {
        applyTheme(savedTheme);
    }
});

// --- KEYBOARD SHORTCUTS ---
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Ignore if typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            // Allow Ctrl+S in editor
            if (e.ctrlKey && e.key === 's' && e.target.isContentEditable) {
                e.preventDefault();
                saveDocument();
            }
            return;
        }
        
        // Navigation shortcuts (Alt + Key)
        if (e.altKey) {
            switch(e.key.toLowerCase()) {
                case 'd': e.preventDefault(); showDashboard(); break;
                case 't': e.preventDefault(); showTeams(); break;
                case 'k': e.preventDefault(); showKanban(); break;
                case 'w': e.preventDefault(); showWhiteboard(); break;
                case 'a': e.preventDefault(); showAnalytics(); break;
                case 'c': e.preventDefault(); showCalendar(); break;
                case 'p': e.preventDefault(); showPolls(); break;
            }
        }
        
        // Action shortcuts
        if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
                case 'n':
                    e.preventDefault();
                    const newTeamInput = document.getElementById('newTeamInput');
                    if (newTeamInput && !newTeamInput.classList.contains('hidden')) {
                        newTeamInput.focus();
                    }
                    break;
                case 'f':
                    e.preventDefault();
                    // Implement search functionality
                    alert('Search functionality - Coming soon!');
                    break;
            }
        }
        
        // Show shortcuts modal
        if (e.key === '?' && !e.shiftKey) {
            e.preventDefault();
            showShortcutsModal();
        }
        
        // Close modals with Escape
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
}

function showShortcutsModal() {
    document.getElementById('shortcutsModal').classList.add('active');
}

function closeShortcutsModal() {
    document.getElementById('shortcutsModal').classList.remove('active');
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
}

// --- AUTHENTICATION & SESSION ---
function toggleAuthForms() {
    document.getElementById('loginForm').classList.toggle('hidden');
    document.getElementById('registerForm').classList.toggle('hidden');
    document.getElementById('loginError').textContent = '';
    document.getElementById('registerError').textContent = '';
    
    // Reset profile image
    const preview = document.getElementById('profileImagePreview');
    preview.className = 'profile-image-placeholder';
    preview.innerHTML = '<span id="profileInitial">üì∑</span>';
    profileImageData = null;
}

function handleProfileImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size should be less than 5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        profileImageData = e.target.result;
        const preview = document.getElementById('profileImagePreview');
        preview.innerHTML = `<img src="${profileImageData}" class="profile-image-preview">`;
        preview.className = '';
    };
    reader.readAsDataURL(file);
}

async function handleRegister() {
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const department = document.getElementById('registerDepartment').value;
    
    if (!username || !email || !password || !department) {
        document.getElementById('registerError').textContent = "All fields are required.";
        return;
    }

    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username, 
                email, 
                password, 
                department,
                profileImage: profileImageData
            })
        });
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            toggleAuthForms();
        } else {
            document.getElementById('registerError').textContent = data.message;
        }
    } catch (error) {
        console.error("Registration failed:", error);
        document.getElementById('registerError').textContent = "An unexpected error occurred.";
    }
}

async function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
        document.getElementById('loginError').textContent = "Username and password are required.";
        return;
    }

    const response = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password})
    });
    const data = await response.json();
    if (response.ok) {
        currentUser = data.username;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
        document.getElementById('usernameDisplay').textContent = `Welcome, ${currentUser}`;
        document.getElementById('localVideoUsername').textContent = currentUser;
        
        // Set user avatar if available
        if (data.profileImage) {
            const avatarImg = document.getElementById('userAvatar');
            avatarImg.src = data.profileImage;
            avatarImg.style.display = 'block';
        }
        
        initializeSocketAndListeners();
    } else {
         document.getElementById('loginError').textContent = data.message;
    }
}

async function handleLogout() {
    await fetch('/api/logout', { method: 'POST' });
    if (socket) socket.disconnect();
    window.location.reload();
}

// --- NAVIGATION ---
function showDashboard() {
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    fetchDashboardData();
}
function showTeams() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.remove('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    loadTeams();
}
function showTeamView() {
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.remove('hidden');
    renderTeamView();
}
function showKanban() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.remove('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    loadKanbanData();
}
function showWhiteboard() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.remove('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    initWhiteboard();
}
function showAnalytics() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.remove('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    loadAnalytics();
}
function showTimeTracking() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.remove('hidden');
    document.getElementById('editorView').classList.add('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('themesView').classList.add('hidden');
    loadTimeEntries();
}
function showEditor() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    document.getElementById('editorView').classList.remove('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('themesView').classList.add('hidden');
    initEditor();
}
function showCalendar() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    document.getElementById('editorView').classList.add('hidden');
    document.getElementById('calendarView').classList.remove('hidden');
    document.getElementById('themesView').classList.add('hidden');
    renderCalendar();
}
function showThemes() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    document.getElementById('editorView').classList.add('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('themesView').classList.remove('hidden');
    initThemes();
}

// --- DASHBOARD & REAL-TIME UPDATES ---
function initializeSocketAndListeners() {
    socket = io();
    socket.on('update-dashboard', (data) => renderDashboard(data));
    
    socket.on('user-joined', (data) => {
        console.log(`${data.username} joined the call`);
        createPeer(data.sid, data.username, true);
    });
    socket.on('offer', (data) => {
        const peer = createPeer(data.from_sid, null, false);
        peer.signal(data.offer);
    });
    socket.on('answer', (data) => {
        if (peers[data.from_sid]) peers[data.from_sid].peer.signal(data.answer);
    });
    socket.on('ice-candidate', (data) => {
        if (peers[data.from_sid]) peers[data.from_sid].peer.signal(data.candidate);
    });
    socket.on('user-left', (data) => {
        if (peers[data.sid]) {
            peers[data.sid].peer.destroy();
            const videoWrapper = document.getElementById(`video-wrapper-${data.sid}`);
            if (videoWrapper) videoWrapper.remove();
            delete peers[data.sid];
        }
    });

    showDashboard();
}

async function fetchDashboardData() {
    const response = await fetch('/api/dashboard_data');
    if (response.ok) {
        const data = await response.json();
        renderDashboard(data);
    }
}

function renderDashboard(data) {
    document.getElementById('totalUsersStat').textContent = data.totalUsers;
    document.getElementById('activeNowStat').textContent = data.activeNow;
    document.getElementById('totalTeamsStat').textContent = data.totalTeams;
    document.getElementById('totalProjectsStat').textContent = data.totalProjects;

    const deptContainer = document.getElementById('departmentOverview');
    deptContainer.innerHTML = '';
    for (const [dept, stats] of Object.entries(data.departmentBreakdown)) {
        const percentage = stats.total > 0 ? (stats.active / stats.total) * 100 : 0;
        deptContainer.innerHTML += `
            <div class="dept-item">
                <div class="dept-item-header"><span>${dept}</span><span>${stats.active} / ${stats.total} Active</span></div>
                <div class="progress-bar"><div class="progress-bar-inner" style="width: ${percentage}%;"></div></div>
            </div>`;
    }

    const activeListContainer = document.getElementById('activeUsersList');
    activeListContainer.innerHTML = data.activeUsersList.length > 0 ? '' : '<p style="text-align:center; color:#6b7280;">No users are currently active.</p>';
    data.activeUsersList.forEach(user => {
        activeListContainer.innerHTML += `<div class="user-item"><div class="user-info"><div class="status-indicator active"></div><div class="details"><strong>${user.username}</strong><div class="email">${user.department}</div></div></div></div>`;
    });

    const allUsersContainer = document.getElementById('allUsersList');
    allUsersContainer.innerHTML = '';
    data.allUsers.forEach(user => {
        allUsersContainer.innerHTML += `
            <div class="user-item">
                <div class="user-info"><div class="status-indicator ${user.isActive ? 'active' : ''}"></div><div class="details"><strong>${user.username}</strong><div class="email">${user.email} - ${user.department}</div></div></div>
                <span style="font-size:12px; color:#9ca3af;">Joined: ${user.registered_at.split(' ')[0]}</span>
            </div>`;
    });
}

// --- TEAMS, PROJECTS, CHAT ---
async function loadTeams() {
    const response = await fetch('/api/teams');
    teams = await response.json();
    renderTeamsList();
}

function renderTeamsList() {
    const container = document.getElementById('teamsList');
    container.innerHTML = teams.map(team => `
        <div class="team-card">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${team.name}</h3>
            <p style="color: #6b7280; margin-bottom: 16px;">${team.members.length} member${team.members.length !== 1 ? 's' : ''}</p>
            <button class="btn-success" onclick="joinTeam(${team.id})">
                ${team.members.includes(currentUser) ? 'Enter Team' : 'Join Team'}
            </button>
        </div>`).join('');
}

async function createTeam() {
    const name = document.getElementById('newTeamInput').value.trim();
    if (!name) return;
    await fetch('/api/teams', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name}) });
    document.getElementById('newTeamInput').value = '';
    loadTeams();
}

async function joinTeam(teamId) {
    const response = await fetch(`/api/teams/${teamId}/join`, {method: 'POST'});
    if (response.ok) {
        selectedTeam = teamId;
        await loadTeams();
        showTeamView();
    }
}

function renderTeamView() {
    const team = teams.find(t => t.id === selectedTeam);
    if (!team) return;
    document.getElementById('membersList').innerHTML = team.members.map(member => `<div class="member-item"><div class="member-avatar">${member[0].toUpperCase()}</div><span>${member}</span></div>`).join('');
    renderProjects(team);
    renderChat(team);
    renderMeetings(team);
}

function renderProjects(team) {
    const container = document.getElementById('projectsList');
    container.innerHTML = team.projects.map(project => {
        let filteredTasks = project.tasks;
        if (currentTaskFilter !== 'all') {
            filteredTasks = project.tasks.filter(t => t.status === currentTaskFilter);
        }
        
        const sortedTasks = [...filteredTasks].sort((a, b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
            if (a.dueDate) return -1;
            if (b.dueDate) return 1;
            return 0;
        });

        return `
        <div class="project-card">
            <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${project.name}</h3>
            <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">Created by ${project.createdBy}</p>
            
            <div class="task-filters">
                <button class="filter-btn ${currentTaskFilter === 'all' ? 'active' : ''}" onclick="filterTasks('all', ${project.id})">All</button>
                <button class="filter-btn ${currentTaskFilter === 'todo' ? 'active' : ''}" onclick="filterTasks('todo', ${project.id})">To Do</button>
                <button class="filter-btn ${currentTaskFilter === 'inprogress' ? 'active' : ''}" onclick="filterTasks('inprogress', ${project.id})">In Progress</button>
                <button class="filter-btn ${currentTaskFilter === 'done' ? 'active' : ''}" onclick="filterTasks('done', ${project.id})">Done</button>
                <button class="filter-btn ${currentTaskFilter === 'blocked' ? 'active' : ''}" onclick="filterTasks('blocked', ${project.id})">Blocked</button>
            </div>
            
            <div id="tasksList${project.id}" style="margin-bottom: 16px;">
                ${sortedTasks.map((task, index) => {
                    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !task.completed;
                    const status = task.status || 'todo';
                    return `
                    <div class="task-item" draggable="true" ondragstart="dragStart(event, ${project.id}, ${task.id})" ondragover="dragOver(event)" ondrop="drop(event, ${project.id}, ${index})">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} 
                            onchange="toggleTask(${project.id}, ${task.id})">
                        <div class="task-content">
                            <div class="task-header">
                                <span class="task-text ${task.completed ? 'task-completed' : ''}">${task.text}</span>
                                <span class="task-status ${status}">${status === 'todo' ? 'To Do' : status === 'inprogress' ? 'In Progress' : status === 'done' ? 'Done' : 'Blocked'}</span>
                            </div>
                            <div class="task-meta">
                                <span>@${task.assignedTo}</span>
                                ${task.dueDate ? `<span class="task-due ${isOverdue ? 'overdue' : ''}">üìÖ ${task.dueDate}${isOverdue ? ' (Overdue)' : ''}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="task-action-btn" onclick="openTaskEditModal(${project.id}, ${task.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="task-action-btn" onclick="deleteTask(${project.id}, ${task.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                `}).join('')}
            </div>
            <div class="flex-row">
                <input type="text" id="taskInput${project.id}" class="flex-1" placeholder="Add task...">
                <button class="btn-success" style="width: auto; padding: 12px 16px;" onclick="addTask(${project.id})">Add</button>
            </div>
        </div>
    `}).join('');
}

function renderChat(team) {
    const container = document.getElementById('chatMessages');
    container.innerHTML = team.chat.map(msg => `
        <div class="chat-message">
            <span class="chat-user ${msg.user === 'System' ? 'system' : ''}">${msg.user}</span>
            <span class="chat-time">${msg.timestamp}</span>
            <div class="chat-text">${msg.message}</div>
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
}

function renderMeetings(team) {
    const container = document.getElementById('meetingsSection');
    container.innerHTML = (team.meetings && team.meetings.length > 0) ? `
        <div class="card">
            <h2 class="section-title">üìÖ Scheduled Meetings</h2>
            ${team.meetings.map(m => `<div class="meeting-item"><div><h3>${m.title}</h3><p>üìÖ ${m.date} at ${m.time}</p><p>Type: ${m.type}</p></div><button class="btn-success btn-small" onclick="startCall('${m.type}')">Join</button></div>`).join('')}
        </div>` : '';
}

async function createProject() {
    const name = document.getElementById('newProjectInput').value.trim();
    if (!name) return;
    await fetch(`/api/teams/${selectedTeam}/projects`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
    });
    document.getElementById('newProjectInput').value = '';
    await loadTeams();
    renderTeamView();
}

async function addTask(projectId) {
    const text = document.getElementById(`taskInput${projectId}`).value.trim();
    if (!text) return;
    await fetch(`/api/teams/${selectedTeam}/projects/${projectId}/tasks`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text})
    });
    document.getElementById(`taskInput${projectId}`).value = '';
    await loadTeams();
    renderTeamView();
}

async function sendMessage() {
    const message = document.getElementById('chatInput').value.trim();
    if (!message) return;
    await fetch(`/api/teams/${selectedTeam}/chat`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message})
    });
    document.getElementById('chatInput').value = '';
    await loadTeams();
    renderTeamView();
}

async function toggleTask(projectId, taskId) {
    await fetch(`/api/teams/${selectedTeam}/projects/${projectId}/tasks/${taskId}/toggle`, {
        method: 'POST'
    });
    await loadTeams();
    renderTeamView();
}

// --- TASK MANAGEMENT ENHANCEMENTS ---
function filterTasks(status, projectId) {
    currentTaskFilter = status;
    renderTeamView();
}

let draggedTask = null;

function dragStart(e, projectId, taskId) {
    draggedTask = { projectId, taskId };
    e.target.classList.add('dragging');
}

function dragOver(e) {
    e.preventDefault();
}

function drop(e, projectId, newIndex) {
    e.preventDefault();
    const draggedEl = document.querySelector('.dragging');
    if (draggedEl) draggedEl.classList.remove('dragging');
    
    if (draggedTask && draggedTask.projectId === projectId) {
        reorderTask(projectId, draggedTask.taskId, newIndex);
    }
    draggedTask = null;
}

async function reorderTask(projectId, taskId, newIndex) {
    await fetch(`/api/teams/${selectedTeam}/projects/${projectId}/tasks/${taskId}/reorder`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ newIndex })
    });
    await loadTeams();
    renderTeamView();
}

function openTaskEditModal(projectId, taskId) {
    const team = teams.find(t => t.id === selectedTeam);
    const project = team.projects.find(p => p.id === projectId);
    const task = project.tasks.find(t => t.id === taskId);
    
    editingTask = { projectId, taskId };
    
    document.getElementById('editTaskText').value = task.text;
    document.getElementById('editTaskStatus').value = task.status || 'todo';
    document.getElementById('editTaskDueDate').value = task.dueDate || '';
    
    const assigneeSelect = document.getElementById('editTaskAssignee');
    assigneeSelect.innerHTML = team.members.map(member => 
        `<option value="${member}" ${member === task.assignedTo ? 'selected' : ''}>${member}</option>`
    ).join('');
    
    document.getElementById('taskEditModal').classList.add('active');
}

function closeTaskEditModal() {
    document.getElementById('taskEditModal').classList.remove('active');
    editingTask = null;
}

async function saveTaskEdit() {
    if (!editingTask) return;
    
    const updates = {
        text: document.getElementById('editTaskText').value.trim(),
        status: document.getElementById('editTaskStatus').value,
        dueDate: document.getElementById('editTaskDueDate').value,
        assignedTo: document.getElementById('editTaskAssignee').value
    };
    
    await fetch(`/api/teams/${selectedTeam}/projects/${editingTask.projectId}/tasks/${editingTask.taskId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updates)
    });
    
    closeTaskEditModal();
    await loadTeams();
    renderTeamView();
}

async function deleteTask(projectId, taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    await fetch(`/api/teams/${selectedTeam}/projects/${projectId}/tasks/${taskId}`, {
        method: 'DELETE'
    });
    
    await loadTeams();
    renderTeamView();
}

// --- MEETINGS ---
function showScheduleModal() {
    document.getElementById('scheduleModal').classList.add('active');
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').classList.remove('active');
}

async function scheduleMeeting() {
    const title = document.getElementById('meetingTitle').value.trim();
    const date = document.getElementById('meetingDate').value;
    const time = document.getElementById('meetingTime').value;
    const type = document.getElementById('meetingType').value;

    if (!title || !date || !time) return;

    const response = await fetch(`/api/teams/${selectedTeam}/meetings`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title, date, time, type})
    });

    if (response.ok) {
        document.getElementById('meetingTitle').value = '';
        document.getElementById('meetingDate').value = '';
        document.getElementById('meetingTime').value = '';
        closeScheduleModal();
        await loadTeams();
        renderTeamView();
    }
}

// --- DOCUMENTS ---
function showDocumentsModal() {
    document.getElementById('documentsModal').classList.add('active');
    renderDocuments();
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').classList.remove('active');
}

function renderDocuments() {
    const team = teams.find(t => t.id === selectedTeam);
    const container = document.getElementById('documentsList');
    
    if (team.documents && team.documents.length > 0) {
        container.innerHTML = team.documents.map(doc => `
            <div class="document-item">
                <div>
                    <h3 style="font-weight: 600;">${doc.name}</h3>
                    <p style="font-size: 12px; color: #6b7280;">
                        ${(doc.size / 1024).toFixed(2)} KB ‚Ä¢ Uploaded by ${doc.uploadedBy}
                    </p>
                    <p style="font-size: 11px; color: #9ca3af;">${doc.uploadedAt}</p>
                </div>
                <div class="document-actions">
                    <button class="icon-btn" onclick="viewDocument(${doc.id})">üëÅÔ∏è</button>
                    <button class="icon-btn" onclick="downloadDocument(${doc.id})">‚¨áÔ∏è</button>
                    <button class="icon-btn" onclick="deleteDocument(${doc.id})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No documents uploaded yet</p>';
    }
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        const response = await fetch(`/api/teams/${selectedTeam}/documents`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result
            })
        });

        if (response.ok) {
            await loadTeams();
            renderDocuments();
            renderTeamView();
        }
    };
    reader.readAsDataURL(file);
}

function viewDocument(docId) {
    const team = teams.find(t => t.id === selectedTeam);
    const doc = team.documents.find(d => d.id === docId);
    if (doc) {
        currentPreviewDoc = doc;
        showPreviewModal(doc);
    }
}

function showPreviewModal(doc) {
    document.getElementById('previewTitle').textContent = doc.name;
    const container = document.getElementById('previewContainer');
    container.innerHTML = '';
    
    const fileType = doc.type || doc.name.split('.').pop().toLowerCase();
    
    if (fileType.includes('image') || ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileType)) {
        container.innerHTML = `<img src="${doc.data}" alt="${doc.name}">`;
    } else if (fileType.includes('pdf') || fileType === 'pdf') {
        container.innerHTML = `<iframe src="${doc.data}"></iframe>`;
    } else if (['txt', 'text', 'plain'].some(t => fileType.includes(t))) {
        fetch(doc.data)
            .then(r => r.text())
            .then(text => {
                container.innerHTML = `<pre style="white-space: pre-wrap; padding: 20px; text-align: left; max-height: 70vh; overflow-y: auto;">${text}</pre>`;
            });
    } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].some(t => fileType.includes(t))) {
        const encodedUrl = encodeURIComponent(doc.data);
        container.innerHTML = `<iframe src="https://docs.google.com/viewer?url=${encodedUrl}&embedded=true"></iframe>`;
    } else {
        container.innerHTML = `
            <div class="preview-unsupported">
                <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                <h3>Preview not available</h3>
                <p>This file type cannot be previewed in the browser.</p>
                <p style="margin-top: 8px; color: #9ca3af;">File: ${doc.name}</p>
                <button class="btn-primary btn-small" style="margin-top: 16px;" onclick="downloadDocument(${doc.id})">Download File</button>
            </div>
        `;
    }
    
    document.getElementById('previewModal').classList.add('active');
}

function closePreviewModal() {
    document.getElementById('previewModal').classList.remove('active');
    currentPreviewDoc = null;
}

function downloadCurrentPreview() {
    if (currentPreviewDoc) {
        downloadDocument(currentPreviewDoc.id);
    }
}

function downloadDocument(docId) {
    const team = teams.find(t => t.id === selectedTeam);
    const doc = team.documents.find(d => d.id === docId);
    if (doc) {
        const link = document.createElement('a');
        link.href = doc.data;
        link.download = doc.name;
        link.click();
    }
}

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) return;

    const response = await fetch(`/api/teams/${selectedTeam}/documents/${docId}`, {
        method: 'DELETE'
    });

    if (response.ok) {
        await loadTeams();
        renderDocuments();
        renderTeamView();
    }
}

// --- WEBRTC CALLS ---
async function startCall(type) {
    callType = type;
    document.getElementById('callModalTitle').textContent = type === 'video' ? 'Video Call' : 'Audio Call';
    
    const localWrapper = document.getElementById('localVideoWrapper');
    localWrapper.classList.toggle('is-audio-only', callType === 'audio');

    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('callModal').classList.add('active');
        socket.emit('join-room', { teamId: selectedTeam });
    } catch (err) {
        console.error("Error accessing media devices:", err);
        alert("Could not access camera/microphone. Please check browser permissions.");
    }
}

function endCall() {
    if (localStream) localStream.getTracks().forEach(track => track.stop());
    if (screenStream) screenStream.getTracks().forEach(track => track.stop());
    screenStream = null;
    isScreenSharing = false;
    socket.emit('leave-room', { teamId: selectedTeam });
    for (let sid in peers) {
        if (peers[sid].peer) peers[sid].peer.destroy();
    }
    peers = {};
    document.getElementById('callModal').classList.remove('active');
    document.querySelectorAll('.remote-video-wrapper').forEach(v => v.remove());
}

// --- SCREEN SHARING ---
async function toggleScreenShare() {
    if (isScreenSharing) {
        stopScreenShare();
    } else {
        await startScreenShare();
    }
}

async function startScreenShare() {
    try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ 
            video: { 
                cursor: 'always',
                displaySurface: 'monitor'
            }, 
            audio: false 
        });

        const videoTrack = screenStream.getVideoTracks()[0];
        
        for (let sid in peers) {
            const sender = peers[sid].peer._pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                sender.replaceTrack(videoTrack);
            }
        }

        document.getElementById('localVideo').srcObject = screenStream;
        document.getElementById('localVideoWrapper').classList.add('is-screen-share');
        
        isScreenSharing = true;
        document.getElementById('shareScreenBtn').classList.add('active');
        document.getElementById('shareScreenText').textContent = 'Stop Sharing';

        videoTrack.onended = () => {
            stopScreenShare();
        };

    } catch (err) {
        console.error('Error sharing screen:', err);
        alert('Could not share screen. Please check permissions.');
    }
}

function stopScreenShare() {
    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
    }

    if (localStream && callType === 'video') {
        const videoTrack = localStream.getVideoTracks()[0];
        
        for (let sid in peers) {
            const sender = peers[sid].peer._pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                sender.replaceTrack(videoTrack);
            }
        }

        document.getElementById('localVideo').srcObject = localStream;
    }

    document.getElementById('localVideoWrapper').classList.remove('is-screen-share');
    isScreenSharing = false;
    document.getElementById('shareScreenBtn').classList.remove('active');
    document.getElementById('shareScreenText').textContent = 'Share Screen';
}

function createPeer(remoteSid, remoteUsername, initiator) {
    if (peers[remoteSid]) return peers[remoteSid].peer;
    
    const peer = new SimplePeer({ initiator, stream: localStream, trickle: false });

    peer.on('signal', (data) => {
        if (data.type === 'offer') {
             socket.emit('offer', { to_sid: remoteSid, offer: data });
        } else if (data.type === 'answer') {
             socket.emit('answer', { to_sid: remoteSid, answer: data });
        } else {
             socket.emit('ice-candidate', { to_sid: remoteSid, candidate: data });
        }
    });

    peer.on('stream', (stream) => {
        const videosContainer = document.getElementById('videosContainer');
        let videoWrapper = document.getElementById(`video-wrapper-${remoteSid}`);
        if (!videoWrapper) {
            videoWrapper = document.createElement('div');
            videoWrapper.id = `video-wrapper-${remoteSid}`;
            videoWrapper.className = 'video-wrapper remote-video-wrapper';
            if (stream.getVideoTracks().length === 0) videoWrapper.classList.add('is-audio-only');
            
            videoWrapper.innerHTML = `
                <div class="audio-avatar"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg></div>
                <video autoplay playsinline></video>
                <p>${remoteUsername || 'New User'}</p>`;
            
            videoWrapper.querySelector('video').srcObject = stream;
            videosContainer.appendChild(videoWrapper);
        }
    });

    peer.on('close', () => {
        const videoWrapper = document.getElementById(`video-wrapper-${remoteSid}`);
        if (videoWrapper) videoWrapper.remove();
        delete peers[remoteSid];
    });
    
    peer.on('error', (err) => {
        console.error(`Error with peer ${remoteSid}:`, err);
    });
    
    peers[remoteSid] = { peer, username: remoteUsername };
    return peer;
}

// --- KANBAN BOARD ---
async function loadKanbanData() {
    const response = await fetch('/api/kanban');
    if (response.ok) {
        kanbanCards = await response.json();
        renderKanbanView();
    }
}

function switchKanbanView(view) {
    currentKanbanView = view;
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('boardView').classList.toggle('hidden', view !== 'board');
    document.getElementById('listView').classList.toggle('hidden', view !== 'list');
    document.getElementById('timelineView').classList.toggle('hidden', view !== 'timeline');
    
    renderKanbanView();
}

function renderKanbanView() {
    if (currentKanbanView === 'board') {
        renderBoardView();
    } else if (currentKanbanView === 'list') {
        renderListView();
    } else if (currentKanbanView === 'timeline') {
        renderTimelineView();
    }
}

function renderBoardView() {
    const columns = {
        todo: { title: 'To Do', cards: [] },
        inprogress: { title: 'In Progress', cards: [] },
        review: { title: 'Review', cards: [] },
        done: { title: 'Done', cards: [] }
    };
    
    kanbanCards.forEach(card => {
        if (columns[card.status]) {
            columns[card.status].cards.push(card);
        }
    });
    
    const boardView = document.getElementById('boardView');
    boardView.innerHTML = Object.entries(columns).map(([status, data]) => `
        <div class="kanban-column" ondrop="dropCard(event, '${status}')" ondragover="allowDrop(event)">
            <div class="kanban-column-header">
                <span class="kanban-column-title">${data.title}</span>
                <span class="kanban-column-count">${data.cards.length}</span>
            </div>
            <div class="kanban-cards">
                ${data.cards.map(card => `
                    <div class="kanban-card" draggable="true" ondragstart="dragCard(event, ${card.id})">
                        <div class="kanban-card-title">${card.title}</div>
                        <p style="font-size: 13px; color: #6b7280; margin-top: 4px;">${card.description || ''}</p>
                        <div class="kanban-card-meta">
                            <span class="kanban-card-priority priority-${card.priority}">${card.priority.toUpperCase()}</span>
                            ${card.dueDate ? `<span>üìÖ ${card.dueDate}</span>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function renderListView() {
    const container = document.getElementById('listViewContent');
    const groupedCards = kanbanCards.reduce((acc, card) => {
        if (!acc[card.status]) acc[card.status] = [];
        acc[card.status].push(card);
        return acc;
    }, {});
    
    container.innerHTML = Object.entries(groupedCards).map(([status, cards]) => `
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="font-weight: 700; margin-bottom: 16px; text-transform: capitalize;">${status.replace('inprogress', 'In Progress')}</h3>
            ${cards.map(card => `
                <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${card.title}</strong>
                            <p style="font-size: 13px; color: #6b7280; margin-top: 4px;">${card.description || ''}</p>
                        </div>
                        <span class="kanban-card-priority priority-${card.priority}">${card.priority.toUpperCase()}</span>
                    </div>
                    ${card.dueDate ? `<p style="font-size: 12px; color: #6b7280; margin-top: 8px;">üìÖ Due: ${card.dueDate}</p>` : ''}
                </div>
            `).join('')}
        </div>
    `).join('');
}

function renderTimelineView() {
    const container = document.getElementById('timelineContent');
    const cardsWithDates = kanbanCards.filter(card => card.dueDate).sort((a, b) => 
        new Date(a.dueDate) - new Date(b.dueDate)
    );
    
    if (cardsWithDates.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No cards with due dates</p>';
        return;
    }
    
    container.innerHTML = cardsWithDates.map(card => `
        <div class="timeline-item">
            <div class="timeline-date">${card.dueDate}</div>
            <div class="timeline-content">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <strong style="font-size: 16px;">${card.title}</strong>
                    <span class="kanban-card-priority priority-${card.priority}">${card.priority.toUpperCase()}</span>
                </div>
                <p style="color: #6b7280;">${card.description || ''}</p>
                <p style="font-size: 12px; color: #2563eb; margin-top: 8px; text-transform: capitalize;">Status: ${card.status.replace('inprogress', 'In Progress')}</p>
            </div>
        </div>
    `).join('');
}

let draggedCardId = null;

function dragCard(event, cardId) {
    draggedCardId = cardId;
    event.target.classList.add('dragging');
}

function allowDrop(event) {
    event.preventDefault();
}

async function dropCard(event, newStatus) {
    event.preventDefault();
    const draggedEl = document.querySelector('.dragging');
    if (draggedEl) draggedEl.classList.remove('dragging');
    
    if (draggedCardId) {
        await fetch(`/api/kanban/${draggedCardId}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        });
        draggedCardId = null;
        await loadKanbanData();
    }
}

function showAddCardModal() {
    document.getElementById('addCardModal').classList.add('active');
}

function closeAddCardModal() {
    document.getElementById('addCardModal').classList.remove('active');
}

async function addKanbanCard() {
    const card = {
        title: document.getElementById('cardTitle').value.trim(),
        description: document.getElementById('cardDescription').value.trim(),
        priority: document.getElementById('cardPriority').value,
        dueDate: document.getElementById('cardDueDate').value,
        status: document.getElementById('cardStatus').value
    };
    
    if (!card.title) return;
    
    await fetch('/api/kanban', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(card)
    });
    
    document.getElementById('cardTitle').value = '';
    document.getElementById('cardDescription').value = '';
    document.getElementById('cardDueDate').value = '';
    closeAddCardModal();
    await loadKanbanData();
}

// --- WHITEBOARD ---
let canvas, ctx;
let startX, startY;
let snapshot;

function initWhiteboard() {
    canvas = document.getElementById('whiteboardCanvas');
    const container = canvas.parentElement;
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight - 80;
    ctx = canvas.getContext('2d');
    
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Real-time cursor sharing
    canvas.addEventListener('mousemove', (e) => {
        if (socket) {
            const rect = canvas.getBoundingClientRect();
            socket.emit('cursor-move', {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top,
                username: currentUser
            });
        }
    });
    
    // Listen for remote cursors
    if (socket) {
        socket.on('remote-cursor', (data) => {
            updateRemoteCursor(data);
        });
        
        socket.on('whiteboard-data', (data) => {
            drawRemoteData(data);
        });
        
        socket.on('whiteboard-clear', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
    }
}

function setTool(tool) {
    whiteboardTool = tool;
    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tool + 'Tool').classList.add('active');
}

function setColor(color) {
    whiteboardColor = color;
}

function setSize(size) {
    whiteboardSize = size;
}

function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    if (whiteboardTool === 'pen' || whiteboardTool === 'eraser') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    } else {
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    ctx.strokeStyle = whiteboardTool === 'eraser' ? '#ffffff' : whiteboardColor;
    ctx.lineWidth = whiteboardSize;
    
    if (whiteboardTool === 'pen' || whiteboardTool === 'eraser') {
        ctx.lineTo(x, y);
        ctx.stroke();
    } else {
        ctx.putImageData(snapshot, 0, 0);
        
        if (whiteboardTool === 'line') {
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(x, y);
            ctx.stroke();
        } else if (whiteboardTool === 'rectangle') {
            ctx.strokeRect(startX, startY, x - startX, y - startY);
        } else if (whiteboardTool === 'circle') {
            const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
            ctx.beginPath();
            ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
            ctx.stroke();
        }
    }
    
    // Broadcast drawing to other users
    if (socket) {
        socket.emit('whiteboard-draw', {
            tool: whiteboardTool,
            color: whiteboardColor,
            size: whiteboardSize,
            startX, startY, x, y
        });
    }
}

function stopDrawing() {
    isDrawing = false;
}

function clearWhiteboard() {
    if (confirm('Clear the entire whiteboard?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (socket) socket.emit('whiteboard-clear');
    }
}

async function saveWhiteboard() {
    const dataURL = canvas.toDataURL('image/png');
    await fetch('/api/whiteboard/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ data: dataURL })
    });
    alert('Whiteboard saved!');
}

async function loadWhiteboard() {
    const response = await fetch('/api/whiteboard/load');
    if (response.ok) {
        const data = await response.json();
        if (data.imageData) {
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
            };
            img.src = data.imageData;
        }
    }
}

function updateRemoteCursor(data) {
    let cursor = remoteCursors[data.username];
    if (!cursor) {
        cursor = document.createElement('div');
        cursor.className = 'cursor-indicator';
        cursor.innerHTML = `<div class="cursor-label">${data.username}</div>`;
        document.getElementById('cursorsContainer').appendChild(cursor);
        remoteCursors[data.username] = cursor;
    }
    cursor.style.left = data.x + 'px';
    cursor.style.top = data.y + 'px';
}

function drawRemoteData(data) {
    ctx.strokeStyle = data.color;
    ctx.lineWidth = data.size;
    
    if (data.tool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(data.startX, data.startY);
        ctx.lineTo(data.x, data.y);
        ctx.stroke();
    }
}

// --- ANALYTICS DASHBOARD ---
async function loadAnalytics() {
    const response = await fetch('/api/analytics');
    if (response.ok) {
        const data = await response.json();
        renderAnalytics(data);
    }
}

function renderAnalytics(data) {
    // Completion Rate
    const completionRate = data.completionRate || 75;
    document.getElementById('completionRate').textContent = completionRate + '%';
    const circle = document.getElementById('completionCircle');
    const circumference = 2 * Math.PI * 50;
    const offset = circumference - (completionRate / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    
    // Engagement Metrics
    const engagementContainer = document.getElementById('engagementMetrics');
    engagementContainer.innerHTML = `
        <div class="metric-row">
            <span class="metric-label">Daily Active Users</span>
            <span class="metric-value">${data.dailyActiveUsers || 0}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Avg. Session Time</span>
            <span class="metric-value">${data.avgSessionTime || '0m'}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Messages Sent</span>
            <span class="metric-value">${data.messagesSent || 0}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Tasks Completed</span>
            <span class="metric-value">${data.tasksCompleted || 0}</span>
        </div>
    `;
    
    // Activity Heatmap
    const heatmapContainer = document.getElementById('activityHeatmap');
    heatmapContainer.innerHTML = '';
    for (let i = 0; i < 28; i++) {
        const activity = data.activityData ? data.activityData[i] || 0 : Math.floor(Math.random() * 5);
        const cell = document.createElement('div');
        cell.className = `heatmap-cell ${activity > 0 ? 'level-' + Math.min(activity, 4) : ''}`;
        cell.title = `Day ${i + 1}: ${activity} activities`;
        heatmapContainer.appendChild(cell);
    }
    
    // Productivity Chart
    renderProductivityChart(data.productivityData);
    
    // Task Analytics Chart
    renderTaskAnalyticsChart(data.taskStats);
}

function renderProductivityChart(data) {
    const canvas = document.getElementById('productivityChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    const chartData = data || [65, 75, 80, 70, 85, 90, 95];
    const barWidth = width / chartData.length;
    const maxValue = Math.max(...chartData);
    
    chartData.forEach((value, index) => {
        const barHeight = (value / maxValue) * (height - 40);
        const x = index * barWidth + 10;
        const y = height - barHeight - 20;
        
        ctx.fillStyle = '#2563eb';
        ctx.fillRect(x, y, barWidth - 20, barHeight);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(value + '%', x + (barWidth - 20) / 2, height - 5);
    });
}

function renderTaskAnalyticsChart(stats) {
    const canvas = document.getElementById('taskAnalyticsChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    const taskData = stats || { todo: 15, inprogress: 8, done: 25, blocked: 2 };
    const total = Object.values(taskData).reduce((a, b) => a + b, 0);
    const colors = { todo: '#3b82f6', inprogress: '#f59e0b', done: '#10b981', blocked: '#ef4444' };
    
    let startAngle = 0;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    Object.entries(taskData).forEach(([status, count]) => {
        const sliceAngle = (count / total) * 2 * Math.PI;
        
        ctx.fillStyle = colors[status];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        startAngle += sliceAngle;
    });
    
    // Legend
    let legendY = 20;
    Object.entries(taskData).forEach(([status, count]) => {
        ctx.fillStyle = colors[status];
        ctx.fillRect(width - 120, legendY, 15, 15);
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`${status}: ${count}`, width - 100, legendY + 12);
        legendY += 25;
    });
}

// --- TIME TRACKING ---
async function loadTimeEntries() {
    const response = await fetch('/api/time-tracking');
    if (response.ok) {
        timeEntries = await response.json();
        renderTimeEntries();
        renderTimeReport();
    }
}

function startTimer() {
    if (!isTimerRunning) {
        isTimerRunning = true;
        document.getElementById('startTimerBtn').disabled = true;
        document.getElementById('stopTimerBtn').disabled = false;
        
        timerInterval = setInterval(() => {
            timerSeconds++;
            updateTimerDisplay();
        }, 1000);
    }
}

function stopTimer() {
    if (isTimerRunning) {
        isTimerRunning = false;
        clearInterval(timerInterval);
        document.getElementById('startTimerBtn').disabled = false;
        document.getElementById('stopTimerBtn').disabled = true;
        
        saveTimeEntry();
    }
}

function resetTimer() {
    timerSeconds = 0;
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const hours = Math.floor(timerSeconds / 3600);
    const minutes = Math.floor((timerSeconds % 3600) / 60);
    const seconds = timerSeconds % 60;
    
    document.getElementById('timerDisplay').textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

async function saveTimeEntry() {
    const taskName = document.getElementById('timeTrackTaskName').value.trim() || 'Untitled Task';
    const duration = timerSeconds;
    
    if (duration < 60) {
        alert('Time entry must be at least 1 minute');
        return;
    }
    
    await fetch('/api/time-tracking', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            taskName,
            duration,
            date: new Date().toISOString()
        })
    });
    
    resetTimer();
    document.getElementById('timeTrackTaskName').value = '';
    await loadTimeEntries();
}

function renderTimeEntries() {
    const container = document.getElementById('timeEntriesList');
    
    if (timeEntries.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No time entries yet</p>';
        return;
    }
    
    container.innerHTML = timeEntries.map(entry => {
        const hours = Math.floor(entry.duration / 3600);
        const minutes = Math.floor((entry.duration % 3600) / 60);
        const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        
        return `
            <div class="time-entry">
                <div class="time-entry-info">
                    <h4>${entry.taskName}</h4>
                    <p>${new Date(entry.date).toLocaleDateString()} ‚Ä¢ ${entry.username || currentUser}</p>
                </div>
                <div class="time-duration">${durationText}</div>
            </div>
        `;
    }).join('');
}

function renderTimeReport() {
    const canvas = document.getElementById('timeReportChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    // Group by date
    const dateGroups = timeEntries.reduce((acc, entry) => {
        const date = new Date(entry.date).toLocaleDateString();
        acc[date] = (acc[date] || 0) + entry.duration / 3600;
        return acc;
    }, {});
    
    const dates = Object.keys(dateGroups).slice(-7);
    const values = dates.map(date => dateGroups[date]);
    
    if (values.length === 0) return;
    
    const barWidth = width / values.length;
    const maxValue = Math.max(...values);
    
    values.forEach((value, index) => {
        const barHeight = (value / maxValue) * (height - 40);
        const x = index * barWidth + 10;
        const y = height - barHeight - 20;
        
        ctx.fillStyle = '#2563eb';
        ctx.fillRect(x, y, barWidth - 20, barHeight);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(value.toFixed(1) + 'h', x + (barWidth - 20) / 2, height - 5);
    });
}

function exportTimeReport() {
    const csvContent = 'Task,Date,Duration (minutes),User\n' + 
        timeEntries.map(entry => 
            `"${entry.taskName}","${new Date(entry.date).toLocaleString()}",${Math.floor(entry.duration / 60)},"${entry.username || currentUser}"`
        ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `time-report-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// --- MEETING RECORDING ---
function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

async function startRecording() {
    try {
        const stream = document.getElementById('localVideo').srcObject;
        if (!stream) {
            alert('No active call to record');
            return;
        }
        
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/webm;codecs=vp9'
        });
        
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            
            // Save recording
            const reader = new FileReader();
            reader.onloadend = async () => {
                await fetch('/api/recordings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        data: reader.result,
                        date: new Date().toISOString(),
                        teamId: selectedTeam
                    })
                });
                
                alert('Recording saved! You can download it from the team documents.');
            };
            reader.readAsDataURL(blob);
            
            // Also offer immediate download
            const link = document.createElement('a');
            link.href = url;
            link.download = `meeting-recording-${new Date().toISOString()}.webm`;
            link.click();
        };
        
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('recordingIndicator').classList.add('active');
        document.getElementById('recordBtn').classList.add('active');
        document.getElementById('recordText').textContent = 'Stop Recording';
        
    } catch (err) {
        console.error('Error starting recording:', err);
        alert('Could not start recording. Please check permissions.');
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('recordingIndicator').classList.remove('active');
        document.getElementById('recordBtn').classList.remove('active');
        document.getElementById('recordText').textContent = 'Record';
    }
}

// --- AI ASSISTANT ---
async function showAISummary() {
    const taskName = document.getElementById('timeTrackTaskName').value.trim();
    if (!taskName) {
        alert('Please enter a task name first');
        return;
    }
    
    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ Generating...';
    
    try {
        const response = await fetch('/api/ai-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                taskName,
                timeSpent: timerSeconds,
                context: 'time tracking'
            })
        });
        
        const data = await response.json();
        if (data.summary) {
            alert(`AI Summary:\n\n${data.summary}`);
        }
    } catch (err) {
        console.error('AI summary error:', err);
        alert('Could not generate AI summary. Please try again.');
    } finally {
        button.disabled = false;
        button.textContent = 'ü§ñ AI Summary';
    }
}

// --- COLLABORATIVE EDITOR ---
async function initEditor() {
    loadDocument();
    loadComments();
    updateActiveUsers();
    
    // Real-time sync
    const editor = document.getElementById('editorContent');
    let typingTimeout;
    
    editor.addEventListener('input', () => {
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            const content = editor.innerHTML;
            if (socket) {
                socket.emit('editor-update', { content, user: currentUser });
            }
        }, 500);
    });
    
    if (socket) {
        socket.on('editor-sync', (data) => {
            if (data.user !== currentUser) {
                document.getElementById('editorContent').innerHTML = data.content;
            }
        });
        
        socket.on('editor-users', (users) => {
            updateEditorUsers(users);
        });
    }
}

function formatText(command, value) {
    document.execCommand(command, false, value);
    document.getElementById('editorContent').focus();
}

async function saveDocument() {
    const content = document.getElementById('editorContent').innerHTML;
    await fetch('/api/document/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content })
    });
    alert('Document saved!');
}

async function loadDocument() {
    const response = await fetch('/api/document/load');
    if (response.ok) {
        const data = await response.json();
        if (data.content) {
            document.getElementById('editorContent').innerHTML = data.content;
        }
    }
}

async function loadComments() {
    const response = await fetch('/api/document/comments');
    if (response.ok) {
        documentComments = await response.json();
        renderComments();
    }
}

async function addComment() {
    const input = document.getElementById('commentInput');
    const text = input.value.trim();
    if (!text) return;
    
    await fetch('/api/document/comments', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text })
    });
    
    input.value = '';
    await loadComments();
}

function renderComments() {
    const container = document.getElementById('documentComments');
    
    if (documentComments.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px; font-size: 13px;">No comments yet</p>';
        return;
    }
    
    container.innerHTML = documentComments.map(comment => `
        <div class="comment-item">
            <div class="comment-author">${comment.username}</div>
            <div class="comment-text">${comment.text}</div>
            <div class="comment-time">${new Date(comment.createdAt).toLocaleString()}</div>
        </div>
    `).join('');
}

function updateActiveUsers() {
    // Simulate active users
    const users = [currentUser];
    updateEditorUsers(users);
}

function updateEditorUsers(users) {
    const container = document.getElementById('editorActiveUsers');
    container.innerHTML = users.map(user => `
        <div class="user-badge">
            <div class="user-badge-dot"></div>
            ${user}
        </div>
    `).join('');
}

// --- CALENDAR ---
async function renderCalendar() {
    await loadCalendarEvents();
    
    const monthYear = document.getElementById('calendarMonthYear');
    const grid = document.getElementById('calendarGrid');
    
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    
    monthYear.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    grid.innerHTML = '';
    
    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        emptyDay.style.opacity = '0.3';
        grid.appendChild(emptyDay);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasEvent = calendarEvents.some(e => e.date === dateStr);
        
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayEl.classList.add('today');
        }
        
        if (hasEvent) {
            dayEl.classList.add('has-event');
        }
        
        dayEl.innerHTML = `
            <div class="calendar-day-number">${day}</div>
            ${hasEvent ? '<div class="calendar-event-dot"></div>' : ''}
        `;
        
        dayEl.onclick = () => showDayEvents(dateStr);
        grid.appendChild(dayEl);
    }
    
    renderCalendarEvents();
}

function changeMonth(delta) {
    calendarDate.setMonth(calendarDate.getMonth() + delta);
    renderCalendar();
}

async function loadCalendarEvents() {
    const response = await fetch('/api/calendar/events');
    if (response.ok) {
        calendarEvents = await response.json();
    }
}

function showDayEvents(date) {
    const events = calendarEvents.filter(e => e.date === date);
    if (events.length > 0) {
        alert(`Events on ${date}:\n\n` + events.map(e => `${e.time} - ${e.title}`).join('\n'));
    }
}

function renderCalendarEvents() {
    const container = document.getElementById('calendarEventsList');
    
    // Get events for current month
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthEvents = calendarEvents.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate.getMonth() === month && eventDate.getFullYear() === year;
    }).sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
    
    if (monthEvents.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No events scheduled</p>';
        return;
    }
    
    container.innerHTML = monthEvents.map(event => {
        const hasConflict = checkConflict(event);
        return `
            <div class="calendar-event-item">
                <div class="event-time">${event.date} at ${event.time}</div>
                <div class="event-title">${event.title}</div>
                <div class="event-attendees">Attendees: ${event.attendees ? event.attendees.join(', ') : 'None'}</div>
                ${hasConflict ? '<div class="conflict-warning">‚ö†Ô∏è Time conflict detected!</div>' : ''}
            </div>
        `;
    }).join('');
}

function checkConflict(event) {
    const eventTime = new Date(event.date + ' ' + event.time);
    return calendarEvents.some(e => {
        if (e.id === event.id) return false;
        const otherTime = new Date(e.date + ' ' + e.time);
        const diff = Math.abs(eventTime - otherTime) / (1000 * 60); // minutes
        return diff < 60; // Conflict if within 1 hour
    });
}

// --- THEMES ---
const themes = {
    default: {
        name: 'Default Blue',
        primary: '#2563eb',
        success: '#10b981',
        danger: '#ef4444',
        background: '#f3f4f6'
    },
    dark: {
        name: 'Dark Mode',
        primary: '#3b82f6',
        success: '#22c55e',
        danger: '#f87171',
        background: '#1f2937'
    },
    purple: {
        name: 'Purple Dream',
        primary: '#8b5cf6',
        success: '#10b981',
        danger: '#ef4444',
        background: '#faf5ff'
    },
    green: {
        name: 'Nature',
        primary: '#10b981',
        success: '#22c55e',
        danger: '#f87171',
        background: '#f0fdf4'
    },
    orange: {
        name: 'Sunset',
        primary: '#f97316',
        success: '#22c55e',
        danger: '#ef4444',
        background: '#fff7ed'
    },
    pink: {
        name: 'Rose',
        primary: '#ec4899',
        success: '#10b981',
        danger: '#ef4444',
        background: '#fdf2f8'
    }
};

function initThemes() {
    const grid = document.getElementById('themeGrid');
    
    grid.innerHTML = Object.entries(themes).map(([key, theme]) => `
        <div class="theme-card ${currentTheme === key ? 'active' : ''}" onclick="applyTheme('${key}')">
            <div class="theme-preview">
                <div class="theme-preview-section" style="background: ${theme.primary}"></div>
                <div class="theme-preview-section" style="background: ${theme.success}"></div>
                <div class="theme-preview-section" style="background: ${theme.danger}"></div>
            </div>
            <div class="theme-name">${theme.name}</div>
        </div>
    `).join('');
}

function applyTheme(themeKey) {
    const theme = themes[themeKey];
    currentTheme = themeKey;
    
    document.documentElement.style.setProperty('--primary-color', theme.primary);
    document.documentElement.style.setProperty('--success-color', theme.success);
    document.documentElement.style.setProperty('--danger-color', theme.danger);
    document.documentElement.style.setProperty('--background-color', theme.background);
    
    // Update all primary buttons
    document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.style.background = theme.primary;
    });
    
    document.querySelectorAll('.btn-success').forEach(btn => {
        btn.style.background = theme.success;
    });
    
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.style.background = theme.danger;
    });
    
    document.body.style.background = theme.background;
    
    // Save preference
    localStorage.setItem('selectedTheme', themeKey);
    
    initThemes(); // Re-render to show active state
}

function applyCustomTheme() {
    const primary = document.getElementById('primaryColor').value;
    const success = document.getElementById('successColor').value;
    const danger = document.getElementById('dangerColor').value;
    const background = document.getElementById('backgroundColor').value;
    
    const customTheme = {
        name: 'Custom',
        primary, success, danger, background
    };
    
    themes.custom = customTheme;
    applyTheme('custom');
}

function resetTheme() {
    applyTheme('default');
    document.getElementById('primaryColor').value = '#2563eb';
    document.getElementById('successColor').value = '#10b981';
    document.getElementById('dangerColor').value = '#ef4444';
    document.getElementById('backgroundColor').value = '#f3f4f6';
}

// --- POLLING SYSTEM ---
async function loadPolls() {
    const response = await fetch('/api/polls');
    if (response.ok) {
        polls = await response.json();
        renderPolls();
    }
}

function addPollOption() {
    const container = document.getElementById('pollOptionsList');
    const optionNum = container.children.length + 1;
    const newOption = document.createElement('div');
    newOption.className = 'poll-option-item';
    newOption.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="Option ${optionNum}" style="flex: 1; margin: 0;">
        <button class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.appendChild(newOption);
}

async function createPoll() {
    const question = document.getElementById('pollQuestion').value.trim();
    const anonymous = document.getElementById('anonymousPoll').checked;
    
    if (!question) {
        alert('Please enter a poll question');
        return;
    }
    
    const optionInputs = document.querySelectorAll('.poll-option-input');
    const options = Array.from(optionInputs)
        .map(input => input.value.trim())
        .filter(text => text.length > 0);
    
    if (options.length < 2) {
        alert('Please add at least 2 options');
        return;
    }
    
    const pollData = {
        question,
        options: options.map(text => ({ text, votes: 0, voters: [] })),
        anonymous,
        status: 'active',
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    await fetch('/api/polls', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(pollData)
    });
    
    // Reset form
    document.getElementById('pollQuestion').value = '';
    document.getElementById('anonymousPoll').checked = false;
    document.getElementById('pollOptionsList').innerHTML = `
        <div class="poll-option-item">
            <input type="text" class="poll-option-input" placeholder="Option 1" style="flex: 1; margin: 0;">
            <button class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
        </div>
        <div class="poll-option-item">
            <input type="text" class="poll-option-input" placeholder="Option 2" style="flex: 1; margin: 0;">
            <button class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
        </div>
    `;
    
    await loadPolls();
}

function renderPolls() {
    const container = document.getElementById('pollsList');
    
    if (polls.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No polls yet. Create one above!</p>';
        return;
    }
    
    container.innerHTML = polls.map(poll => {
        const totalVotes = poll.options.reduce((sum, opt) => sum + opt.votes, 0);
        const hasVoted = poll.options.some(opt => opt.voters.includes(currentUser));
        const isClosed = poll.status === 'closed';
        
        return `
            <div class="poll-card animate-fade-in">
                <div class="poll-question">${poll.question}</div>
                
                <div class="poll-status">
                    <span class="poll-badge ${poll.status}">${poll.status === 'active' ? 'Active' : 'Closed'}</span>
                    ${poll.anonymous ? '<span class="poll-badge anonymous">Anonymous</span>' : ''}
                </div>
                
                ${poll.options.map((option, index) => {
                    const percentage = totalVotes > 0 ? (option.votes / totalVotes * 100).toFixed(1) : 0;
                    const isSelected = option.voters.includes(currentUser);
                    
                    return `
                        <div class="poll-option ${isSelected ? 'selected' : ''} ${hasVoted || isClosed ? 'voted' : ''}" 
                             onclick="${!hasVoted && !isClosed ? `votePoll(${poll.id}, ${index})` : ''}">
                            <div class="poll-progress" style="width: ${hasVoted || isClosed ? percentage : 0}%"></div>
                            <div class="poll-option-text">
                                <span>${option.text}</span>
                                ${hasVoted || isClosed ? `<span class="poll-votes">${option.votes} votes (${percentage}%)</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <div class="poll-meta">
                    <div>
                        <strong>${totalVotes}</strong> total votes
                        ${poll.anonymous ? '' : ` ‚Ä¢ Created by ${poll.createdBy}`}
                    </div>
                    <div>
                        ${poll.createdBy === currentUser && poll.status === 'active' ? 
                            `<button class="btn-danger btn-small" onclick="closePoll(${poll.id})">Close Poll</button>` : 
                            ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function votePoll(pollId, optionIndex) {
    await fetch(`/api/polls/${pollId}/vote`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ optionIndex })
    });
    
    await loadPolls();
}

async function closePoll(pollId) {
    if (!confirm('Are you sure you want to close this poll?')) return;
    
    await fetch(`/api/polls/${pollId}/close`, {
        method: 'POST'
    });
    
    await loadPolls();
}
function showPolls() {
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('teamsView').classList.add('hidden');
    document.getElementById('teamView').classList.add('hidden');
    document.getElementById('kanbanView').classList.add('hidden');
    document.getElementById('whiteboardView').classList.add('hidden');
    document.getElementById('analyticsView').classList.add('hidden');
    document.getElementById('timeTrackingView').classList.add('hidden');
    document.getElementById('editorView').classList.add('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('themesView').classList.add('hidden');
    document.getElementById('pollsView').classList.remove('hidden');
    loadPolls();
}

// ==================== ATTENDANCE DEVICE FUNCTIONS ====================

// Navigation
function showAttendanceDevice() {
    hideAllViews();
    document.getElementById('attendanceDeviceView').classList.remove('hidden');
    initializeAttendanceDevice();
}

// State Management
let attendanceStatus = {
    checkedIn: false,
    checkInTime: null,
    checkOutTime: null,
    currentBreak: null,
    breaks: [],
    location: 'office_main',
    workMode: 'full_time'
};

function initializeAttendanceDevice() {
    loadAttendanceStatus();
    startLiveClock();
    updateDeviceUI();
}

function loadAttendanceStatus() {
    const saved = localStorage.getItem('attendanceDeviceStatus');
    if (saved) {
        attendanceStatus = JSON.parse(saved);
    }
}

function saveAttendanceStatus() {
    localStorage.setItem('attendanceDeviceStatus', JSON.stringify(attendanceStatus));
}

// Live Clock
function startLiveClock() {
    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').textContent = 
            now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
        
        if (attendanceStatus.checkedIn && !attendanceStatus.currentBreak) {
            updateSessionDuration();
        }
        
        if (attendanceStatus.currentBreak) {
            updateBreakDuration();
        }
    }
    
    updateClock();
    setInterval(updateClock, 1000);
}

// UI Updates
function updateDeviceUI() {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const checkinTimeDisplay = document.getElementById('checkinTimeDisplay');
    const sessionDurationDisplay = document.getElementById('sessionDurationDisplay');
    const breaksCountDisplay = document.getElementById('breaksCountDisplay');
    
    const quickCheckinBtn = document.getElementById('quickCheckinBtn');
    const quickCheckoutBtn = document.getElementById('quickCheckoutBtn');
    const breakBtn = document.getElementById('breakBtn');
    
    if (attendanceStatus.checkedIn) {
        if (attendanceStatus.currentBreak) {
            statusIndicator.className = 'status-indicator on-break';
            statusText.textContent = `On Break (${attendanceStatus.currentBreak.type})`;
            breakBtn.innerHTML = '<span class="btn-icon">‚èπÔ∏è</span><span class="btn-text">End Break</span><span class="btn-subtext">Click to end</span>';
        } else {
            statusIndicator.className = 'status-indicator checked-in';
            statusText.textContent = 'Checked In - Working';
            breakBtn.innerHTML = '<span class="btn-icon">‚òï</span><span class="btn-text">Take Break</span><span class="btn-subtext">Need a break?</span>';
        }
        
        checkinTimeDisplay.textContent = new Date(attendanceStatus.checkInTime).toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        quickCheckinBtn.disabled = true;
        quickCheckoutBtn.disabled = false;
        breakBtn.disabled = false;
        
    } else {
        statusIndicator.className = 'status-indicator checked-out';
        statusText.textContent = 'Not Checked In';
        checkinTimeDisplay.textContent = '--:--';
        sessionDurationDisplay.textContent = '0h 0m';
        
        quickCheckinBtn.disabled = false;
        quickCheckoutBtn.disabled = true;
        breakBtn.disabled = true;
    }
    
    breaksCountDisplay.textContent = attendanceStatus.breaks.length;
}

// Check-in Functions
function quickCheckIn() {
    const notes = document.getElementById('checkinNotes').value.trim();
    const location = document.getElementById('workLocation').value;
    const workMode = document.getElementById('workMode').value;
    
    performCheckIn(notes, location, workMode);
}

function detailedCheckIn() {
    const notes = document.getElementById('checkinNotes').value.trim();
    const location = document.getElementById('workLocation').value;
    const workMode = document.getElementById('workMode').value;
    
    if (!notes) {
        alert('Please add some notes about your work plans for today.');
        return;
    }
    
    performCheckIn(notes, location, workMode);
}

function performCheckIn(notes, location, workMode) {
    const now = new Date();
    
    attendanceStatus = {
        checkedIn: true,
        checkInTime: now.toISOString(),
        checkOutTime: null,
        currentBreak: null,
        breaks: [],
        location: location,
        workMode: workMode,
        notes: notes
    };
    
    // Save to server
    saveCheckInToServer(now, notes, location, workMode);
    
    saveAttendanceStatus();
    updateDeviceUI();
    
    alert(`‚úÖ Checked in successfully at ${now.toLocaleTimeString()}\nLocation: ${getLocationName(location)}\nMode: ${getWorkModeName(workMode)}`);
    
    // Clear form
    document.getElementById('checkinNotes').value = '';
}

// Check-out Functions
function quickCheckOut() {
    if (!attendanceStatus.checkedIn) {
        alert('You are not checked in!');
        return;
    }
    
    if (attendanceStatus.currentBreak) {
        alert('Please end your break before checking out!');
        return;
    }
    
    const confirmCheckout = confirm('Are you sure you want to check out? This will end your work session.');
    if (!confirmCheckout) return;
    
    performCheckOut();
}

function performCheckOut() {
    const now = new Date();
    const checkInTime = new Date(attendanceStatus.checkInTime);
    
    // Calculate total time
    const totalMilliseconds = now - checkInTime;
    const totalHours = (totalMilliseconds / (1000 * 60 * 60)).toFixed(2);
    
    // Calculate actual work time (subtract breaks)
    let breakTime = 0;
    attendanceStatus.breaks.forEach(breakItem => {
        if (breakItem.endTime) {
            breakTime += (new Date(breakItem.endTime) - new Date(breakItem.startTime));
        }
    });
    const workHours = ((totalMilliseconds - breakTime) / (1000 * 60 * 60)).toFixed(2);
    
    // Save to server
    saveCheckOutToServer(now, totalHours, workHours);
    
    // Show summary
    const summary = `üö™ Checked out successfully!\n\nüìä Work Summary:\n‚Ä¢ Total Time: ${totalHours}h\n‚Ä¢ Actual Work: ${workHours}h\n‚Ä¢ Breaks: ${attendanceStatus.breaks.length}\n‚Ä¢ Location: ${getLocationName(attendanceStatus.location)}`;
    
    // Reset status
    attendanceStatus = {
        checkedIn: false,
        checkInTime: null,
        checkOutTime: null,
        currentBreak: null,
        breaks: []
    };
    
    saveAttendanceStatus();
    updateDeviceUI();
    
    alert(summary);
}

// Break Management
function toggleBreak() {
    if (!attendanceStatus.checkedIn) {
        alert('Please check in first!');
        return;
    }
    
    if (attendanceStatus.currentBreak) {
        endCurrentBreak();
    } else {
        startQuickBreak('coffee');
    }
}

function startQuickBreak(breakType) {
    const breakTypes = {
        coffee: { name: 'Coffee Break', duration: 15 },
        lunch: { name: 'Lunch Break', duration: 60 },
        personal: { name: 'Personal Break', duration: 10 }
    };
    
    const breakInfo = {
        type: breakType,
        name: breakTypes[breakType].name,
        startTime: new Date().toISOString(),
        plannedDuration: breakTypes[breakType].duration,
        endTime: null
    };
    
    attendanceStatus.currentBreak = breakInfo;
    saveAttendanceStatus();
    updateDeviceUI();
    
    // Show active break section
    document.getElementById('activeBreakSection').style.display = 'block';
    document.getElementById('activeBreakType').textContent = breakInfo.name;
    
    alert(`‚òï ${breakInfo.name} started! Remember to end your break.`);
}

function endCurrentBreak() {
    if (!attendanceStatus.currentBreak) {
        alert('No active break!');
        return;
    }
    
    const endTime = new Date();
    attendanceStatus.currentBreak.endTime = endTime.toISOString();
    
    // Calculate actual duration
    const startTime = new Date(attendanceStatus.currentBreak.startTime);
    const actualDuration = Math.round((endTime - startTime) / (1000 * 60)); // minutes
    
    attendanceStatus.breaks.push(attendanceStatus.currentBreak);
    attendanceStatus.currentBreak = null;
    
    saveAttendanceStatus();
    updateDeviceUI();
    
    // Hide active break section
    document.getElementById('activeBreakSection').style.display = 'none';
    
    alert(`‚úÖ Break ended! Duration: ${actualDuration} minutes`);
}

// Utility Functions
function updateSessionDuration() {
    if (attendanceStatus.checkedIn && attendanceStatus.checkInTime && !attendanceStatus.currentBreak) {
        const now = new Date();
        const checkInTime = new Date(attendanceStatus.checkInTime);
        const diffMs = now - checkInTime;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        document.getElementById('sessionDurationDisplay').textContent = `${hours}h ${minutes}m`;
    }
}

function updateBreakDuration() {
    if (attendanceStatus.currentBreak) {
        const now = new Date();
        const startTime = new Date(attendanceStatus.currentBreak.startTime);
        const diffMs = now - startTime;
        const minutes = Math.floor(diffMs / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        
        document.getElementById('activeBreakDuration').textContent = `Duration: ${minutes}m ${seconds}s`;
    }
}

function showTodayLog() {
    const today = new Date().toISOString().split('T')[0];
    let log = `üìù Today's Activity Log (${today})\n\n`;
    
    if (attendanceStatus.checkedIn) {
        const checkInTime = new Date(attendanceStatus.checkInTime);
        log += `‚úÖ Checked In: ${checkInTime.toLocaleTimeString()}\n`;
        log += `üìç Location: ${getLocationName(attendanceStatus.location)}\n`;
        log += `üíº Mode: ${getWorkModeName(attendanceStatus.workMode)}\n\n`;
        
        if (attendanceStatus.breaks.length > 0) {
            log += `‚òï Breaks Taken:\n`;
            attendanceStatus.breaks.forEach((breakItem, index) => {
                const start = new Date(breakItem.startTime);
                const end = new Date(breakItem.endTime);
                const duration = Math.round((end - start) / (1000 * 60));
                log += `  ${index + 1}. ${breakItem.name}: ${duration}min\n`;
            });
        } else {
            log += `No breaks taken yet.\n`;
        }
    } else {
        log += `No activity recorded for today.\n`;
    }
    
    alert(log);
}

function getLocationName(locationCode) {
    const locations = {
        'office_main': 'Main Office',
        'office_branch': 'Branch Office',
        'remote': 'Remote Work',
        'client_site': 'Client Site',
        'other': 'Other Location'
    };
    return locations[locationCode] || 'Unknown';
}

function getWorkModeName(modeCode) {
    const modes = {
        'full_time': 'Full Time',
        'part_time': 'Part Time',
        'flexible': 'Flexible Hours',
        'overtime': 'Overtime'
    };
    return modes[modeCode] || 'Unknown';
}

// Server communication (stubs)
function saveCheckInToServer(timestamp, notes, location, workMode) {
    console.log('Saving check-in to server:', { timestamp, notes, location, workMode });
    // Actual implementation would use fetch to your backend
}

function saveCheckOutToServer(timestamp, totalHours, workHours) {
    console.log('Saving check-out to server:', { timestamp, totalHours, workHours });
    // Actual implementation would use fetch to your backend
}

// ==================== ATTENDANCE SUMMARY FUNCTIONS ====================

// Navigation
function showAttendanceSummary() {
    hideAllViews();
    document.getElementById('attendanceSummaryView').classList.remove('hidden');
    loadAttendanceSummary();
}

// Initialization
function loadAttendanceSummary() {
    // Set default date range to current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('summaryStartDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('summaryEndDate').value = lastDay.toISOString().split('T')[0];
    
    generateAttendanceReport();
}

// Report Generation
function generateAttendanceReport() {
    const startDate = document.getElementById('summaryStartDate').value;
    const endDate = document.getElementById('summaryEndDate').value;
    const department = document.getElementById('summaryDepartment').value;
    const reportType = document.getElementById('reportType').value;
    
    fetchAttendanceData(startDate, endDate, department, reportType);
}

// Data Fetching
async function fetchAttendanceData(startDate, endDate, department, reportType) {
    try {
        console.log('Fetching attendance data from API...');
        const response = await fetch('/api/attendance/summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                startDate: startDate,
                endDate: endDate,
                department: department,
                reportType: reportType
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('API response received:', data);
            updateSummaryUI(data);
            renderCharts(data);
        } else {
            console.warn('Server error loading attendance data, using mock data');
            const mockData = generateMockAttendanceSummary(startDate, endDate);
            updateSummaryUI(mockData);
            renderCharts(mockData);
        }
    } catch (error) {
        console.warn('Error fetching attendance data, using mock data:', error);
        const mockData = generateMockAttendanceSummary(startDate, endDate);
        updateSummaryUI(mockData);
        renderCharts(mockData);
    }
}

// Mock Data Generation
function generateMockAttendanceSummary(startDate, endDate) {
    const demoUsers = [
        { id: 1, username: 'john_doe', department: 'Engineering' },
        { id: 2, username: 'jane_smith', department: 'HR' },
        { id: 3, username: 'bob_wilson', department: 'Marketing' },
        { id: 4, username: 'alice_brown', department: 'Sales' },
        { id: 5, username: 'charlie_davis', department: 'Finance' },
        { id: 6, username: 'diana_lee', department: 'Operations' }
    ];
    
    const records = [];
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date().toISOString().split('T')[0];
    
    demoUsers.forEach(user => {
        let currentDate = new Date(start);
        while (currentDate <= end) {
            if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const statusRoll = Math.random();
                
                let status, checkIn, checkOut, hoursWorked;
                
                if (statusRoll > 0.85) {
                    status = 'Absent';
                    checkIn = null;
                    checkOut = null;
                    hoursWorked = 0;
                } else if (statusRoll > 0.75) {
                    status = 'Late';
                    checkIn = `09:${Math.floor(Math.random() * 45)}:00`;
                    checkOut = `17:${Math.floor(Math.random() * 30)}:00`;
                    hoursWorked = calculateHoursWorked(checkIn, checkOut);
                } else {
                    status = 'Present';
                    checkIn = `08:${Math.floor(Math.random() * 30)}:00`;
                    checkOut = `17:${Math.floor(Math.random() * 30)}:00`;
                    hoursWorked = calculateHoursWorked(checkIn, checkOut);
                }
                
                records.push({
                    id: `${user.id}-${dateStr}`,
                    userId: user.id,
                    username: user.username,
                    department: user.department,
                    date: dateStr,
                    status: status,
                    checkIn: checkIn,
                    checkOut: checkOut,
                    hoursWorked: hoursWorked,
                    location: 'office_main',
                    workMode: 'full_time'
                });
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
    });
    
    // Calculate summary
    const uniqueEmployees = [...new Set(records.map(r => r.userId))].length;
    const todayRecords = records.filter(r => r.date === today);
    const presentToday = todayRecords.filter(r => r.status === 'Present').length;
    const absentToday = todayRecords.filter(r => r.status === 'Absent').length;
    
    const totalRecords = records.length;
    const presentRecords = records.filter(r => r.status === 'Present').length;
    const avgAttendance = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
    
    // Calculate employee stats
    const employeeStats = calculateEmployeeStats(records);
    
    // Generate mock analytics
    const analytics = generateMockAnalytics(records);
    
    return {
        summary: {
            totalEmployees: uniqueEmployees,
            presentToday: presentToday,
            absentToday: absentToday,
            avgAttendance: `${avgAttendance}%`,
            totalWorkHours: records.reduce((sum, r) => sum + r.hoursWorked, 0),
            avgWorkHours: (records.reduce((sum, r) => sum + r.hoursWorked, 0) / uniqueEmployees).toFixed(1)
        },
        records: records,
        stats: employeeStats,
        analytics: analytics
    };
}

function generateMockAnalytics(records) {
    const departments = [...new Set(records.map(r => r.department))];
    
    // Department rates
    const departmentRates = departments.map(dept => {
        const deptRecords = records.filter(r => r.department === dept);
        const present = deptRecords.filter(r => r.status === 'Present').length;
        const total = deptRecords.length;
        return {
            department: dept,
            attendanceRate: total > 0 ? Math.round((present / total) * 100) : 0,
            totalEmployees: new Set(deptRecords.map(r => r.userId)).size
        };
    });
    
    // Daily trend (last 7 days)
    const dailyTrend = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayRecords = records.filter(r => r.date === dateStr);
        const present = dayRecords.filter(r => r.status === 'Present').length;
        const total = new Set(dayRecords.map(r => r.userId)).size;
        
        dailyTrend.push({
            date: dateStr,
            attendanceRate: total > 0 ? Math.round((present / total) * 100) : 0,
            presentCount: present,
            totalCount: total
        });
    }
    
    // Punctuality
    const punctuality = [];
    const users = [...new Set(records.map(r => r.username))];
    users.slice(0, 5).forEach(username => {
        const userRecords = records.filter(r => r.username === username && r.checkIn);
        const onTime = userRecords.filter(r => {
            if (!r.checkIn) return false;
            const [hours] = r.checkIn.split(':').map(Number);
            return hours < 9 || (hours === 9 && Math.random() > 0.3);
        }).length;
        
        punctuality.push({
            username: username,
            punctualityRate: userRecords.length > 0 ? Math.round((onTime / userRecords.length) * 100) : 0,
            totalRecords: userRecords.length
        });
    });
    
    // Break patterns
    const breakPatterns = [
        { type: 'Coffee Break', count: Math.floor(Math.random() * 50) + 10 },
        { type: 'Lunch Break', count: Math.floor(Math.random() * 30) + 5 },
        { type: 'Personal Break', count: Math.floor(Math.random() * 40) + 8 }
    ];
    
    return {
        departmentRates: departmentRates,
        dailyTrend: dailyTrend,
        punctuality: punctuality,
        breakPatterns: breakPatterns
    };
}

function calculateEmployeeStats(records) {
    const employeeData = {};
    
    records.forEach(record => {
        if (!employeeData[record.username]) {
            employeeData[record.username] = {
                presentCount: 0,
                totalRecords: 0,
                totalHours: 0,
                overtimeHours: 0
            };
        }
        
        employeeData[record.username].totalRecords++;
        if (record.status === 'Present') {
            employeeData[record.username].presentCount++;
        }
        
        employeeData[record.username].totalHours += record.hoursWorked;
        if (record.hoursWorked > 8) {
            employeeData[record.username].overtimeHours += (record.hoursWorked - 8);
        }
    });
    
    if (Object.keys(employeeData).length === 0) {
        return {
            mostPunctual: '-',
            mostAbsences: '-',
            avgWorkHours: '-',
            totalOvertime: '-'
        };
    }
    
    const employees = Object.entries(employeeData);
    const mostPunctual = employees.reduce((max, [username, data]) => {
        const rate = data.totalRecords > 0 ? (data.presentCount / data.totalRecords) * 100 : 0;
        const maxRate = max.data.totalRecords > 0 ? (max.data.presentCount / max.data.totalRecords) * 100 : 0;
        return rate > maxRate ? { username, data, rate } : max;
    }, { username: '', data: { presentCount: 0, totalRecords: 0 }, rate: 0 });
    
    const mostAbsences = employees.reduce((min, [username, data]) => {
        const rate = data.totalRecords > 0 ? (data.presentCount / data.totalRecords) * 100 : 0;
        const minRate = min.data.totalRecords > 0 ? (min.data.presentCount / min.data.totalRecords) * 100 : 100;
        return rate < minRate ? { username, data, rate } : min;
    }, { username: '', data: { presentCount: 0, totalRecords: 0 }, rate: 100 });
    
    const totalHours = employees.reduce((sum, [_, data]) => sum + data.totalHours, 0);
    const totalOvertime = employees.reduce((sum, [_, data]) => sum + data.overtimeHours, 0);
    
    return {
        mostPunctual: `${mostPunctual.username} (${Math.round(mostPunctual.rate)}%)`,
        mostAbsences: `${mostAbsences.username} (${Math.round(mostAbsences.rate)}%)`,
        avgWorkHours: `${(totalHours / employees.length).toFixed(1)}h`,
        totalOvertime: `${totalOvertime.toFixed(1)}h`
    };
}

// UI Updates
function updateSummaryUI(data) {
    // Update summary cards
    document.getElementById('summaryTotalEmployees').textContent = data.summary.totalEmployees;
    document.getElementById('summaryPresentToday').textContent = data.summary.presentToday;
    document.getElementById('summaryAbsentToday').textContent = data.summary.absentToday;
    document.getElementById('summaryAvgAttendance').textContent = data.summary.avgAttendance;
    
    // Update table
    renderAttendanceTable(data.records);
    
    // Update employee stats
    document.getElementById('mostPunctual').textContent = data.stats.mostPunctual;
    document.getElementById('mostAbsences').textContent = data.stats.mostAbsences;
    document.getElementById('avgWorkHours').textContent = data.stats.avgWorkHours;
    document.getElementById('totalOvertime').textContent = data.stats.totalOvertime;
}

function renderAttendanceTable(records) {
    const tbody = document.getElementById('attendanceSummaryBody');
    
    if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280; padding: 40px;">No attendance records found</td></tr>';
        return;
    }
    
    tbody.innerHTML = records.map(record => `
        <tr>
            <td>${record.username}</td>
            <td>${record.department}</td>
            <td>${formatDisplayDate(record.date)}</td>
            <td>
                <span class="task-status ${getStatusClass(record.status)}">
                    ${record.status}
                </span>
            </td>
            <td>${record.checkIn || '--:--'}</td>
            <td>${record.checkOut || '--:--'}</td>
            <td>${record.hoursWorked || 0}h</td>
            <td>${getLocationName(record.location) || 'Office'}</td>
        </tr>
    `).join('');
}

// Chart Rendering
function renderCharts(data) {
    renderDepartmentChart(data.analytics?.departmentRates || []);
    renderTrendChart(data.analytics?.dailyTrend || []);
    renderPunctualityChart(data.analytics?.punctuality || []);
    renderBreakChart(data.analytics?.breakPatterns || []);
}

function renderDepartmentChart(departmentRates) {
    const canvas = document.getElementById('departmentChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    if (departmentRates.length === 0) {
        ctx.fillStyle = '#6b7280';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', width / 2, height / 2);
        return;
    }
    
    const barWidth = (width - 100) / departmentRates.length;
    const maxRate = Math.max(...departmentRates.map(d => d.attendanceRate), 100);
    
    departmentRates.forEach((dept, index) => {
        const barHeight = (dept.attendanceRate / maxRate) * (height - 60);
        const x = 50 + index * barWidth;
        const y = height - barHeight - 30;
        
        ctx.fillStyle = '#2563eb';
        ctx.fillRect(x, y, barWidth - 10, barHeight);
        
        // Department label
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(dept.department.substring(0, 8), x + (barWidth - 10) / 2, height - 10);
        
        // Percentage label
        ctx.fillStyle = '#059669';
        ctx.fillText(dept.attendanceRate + '%', x + (barWidth - 10) / 2, y - 5);
    });
}

function renderTrendChart(dailyTrend) {
    const canvas = document.getElementById('trendChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    if (dailyTrend.length === 0) return;
    
    const pointWidth = (width - 100) / (dailyTrend.length - 1);
    const maxRate = 100;
    
    ctx.strokeStyle = '#10b981';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    dailyTrend.forEach((day, index) => {
        const x = 50 + index * pointWidth;
        const y = height - (day.attendanceRate / maxRate) * (height - 60) - 30;
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
        
        // Draw points
        ctx.fillStyle = '#10b981';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        
        // Date label
        ctx.fillStyle = '#6b7280';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(day.date.split('-')[2], x, height - 10);
        
        // Rate label
        ctx.fillStyle = '#374151';
        ctx.fillText(day.attendanceRate + '%', x, y - 10);
    });
    
    ctx.stroke();
}

function renderPunctualityChart(punctualityData) {
    const canvas = document.getElementById('punctualityChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    if (punctualityData.length === 0) return;
    
    // Take top 5 most punctual
    const topPunctual = punctualityData
        .sort((a, b) => b.punctualityRate - a.punctualityRate)
        .slice(0, 5);
    
    const barWidth = (width - 100) / topPunctual.length;
    const maxRate = 100;
    
    topPunctual.forEach((employee, index) => {
        const barHeight = (employee.punctualityRate / maxRate) * (height - 60);
        const x = 50 + index * barWidth;
        const y = height - barHeight - 30;
        
        ctx.fillStyle = '#f59e0b';
        ctx.fillRect(x, y, barWidth - 10, barHeight);
        
        // Name label (shortened)
        ctx.fillStyle = '#374151';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        const shortName = employee.username.length > 6 ? employee.username.substring(0, 6) + '...' : employee.username;
        ctx.fillText(shortName, x + (barWidth - 10) / 2, height - 10);
        
        // Percentage label
        ctx.fillStyle = '#92400e';
        ctx.fillText(employee.punctualityRate + '%', x + (barWidth - 10) / 2, y - 5);
    });
}

function renderBreakChart(breakPatterns) {
    const canvas = document.getElementById('breakChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    if (breakPatterns.length === 0) return;
    
    const totalBreaks = breakPatterns.reduce((sum, pattern) => sum + pattern.count, 0);
    if (totalBreaks === 0) return;
    
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    let startAngle = 0;
    
    breakPatterns.forEach((pattern, index) => {
        const sliceAngle = (pattern.count / totalBreaks) * 2 * Math.PI;
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        startAngle += sliceAngle;
    });
    
    // Legend
    let legendY = 20;
    breakPatterns.forEach((pattern, index) => {
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(width - 120, legendY, 15, 15);
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`${pattern.type}: ${pattern.count}`, width - 100, legendY + 12);
        legendY += 20;
    });
}

// Export Functions
async function downloadAttendanceCSV() {
    const startDate = document.getElementById('summaryStartDate').value;
    const endDate = document.getElementById('summaryEndDate').value;
    const department = document.getElementById('summaryDepartment').value;
    
    try {
        const response = await fetch('/api/attendance/export/csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                startDate: startDate,
                endDate: endDate,
                department: department
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Download the CSV
                const blob = new Blob([data.csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = data.filename || `attendance-${startDate}-to-${endDate}.csv`;
                link.click();
            } else {
                alert('Error exporting CSV: ' + (data.error || 'Unknown error'));
            }
        } else {
            alert('Error exporting CSV: Server error');
        }
    } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Error exporting CSV. Please try again.');
    }
}

function downloadAttendancePDF() {
    alert('PDF export functionality would be implemented here');
    // In production, you would use a library like jsPDF
}

function printAttendanceReport() {
    window.print();
}

// Utility Functions
function calculateHoursWorked(checkIn, checkOut) {
    if (!checkIn || !checkOut) return 0;
    
    const [inHours, inMinutes] = checkIn.split(':').map(Number);
    const [outHours, outMinutes] = checkOut.split(':').map(Number);
    
    const totalMinutes = (outHours * 60 + outMinutes) - (inHours * 60 + inMinutes);
    return (totalMinutes / 60).toFixed(2);
}

function formatDisplayDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function getStatusClass(status) {
    const classes = {
        'Present': 'done',
        'Absent': 'blocked',
        'Late': 'inprogress',
        'Half-day': 'todo',
        'Leave': 'blocked'
    };
    return classes[status] || 'todo';
}

function getLocationName(locationCode) {
    const locations = {
        'office_main': 'Main Office',
        'office_branch': 'Branch Office',
        'remote': 'Remote Work',
        'client_site': 'Client Site',
        'other': 'Other Location'
    };
    return locations[locationCode] || 'Unknown';
}

// Helper function to hide all views
function hideAllViews() {
    const views = [
        'dashboardView', 'teamsView', 'teamView', 'kanbanView', 'whiteboardView',
        'analyticsView', 'timeTrackingView', 'editorView', 'calendarView',
        'themesView', 'pollsView', 'attendanceDeviceView', 'attendanceSummaryView'
    ];
    
    views.forEach(view => {
        const element = document.getElementById(view);
        if (element) element.classList.add('hidden');
    });
}
// Load saved theme on startup
const savedTheme = localStorage.getItem('selectedTheme');
if (savedTheme && themes[savedTheme]) {
    applyTheme(savedTheme);
}
    </script>
</body>
</html>
